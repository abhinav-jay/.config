{const e=this,t=e;(()=>{var n={374:e=>{function createLock({maxActiveReader:e=1/0}={}){let t,n,r=0;const a={read:e=>que(e,!1),write:e=>que(e,!0),length:0};return a;function que(e,r){const s=createTask({fn:e,block:r});return n?(n.next=s,s.prev=n,n=s,t||(t=n)):t=n=s,a.length++,deque(),s.q.promise}function defer(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}function createTask({fn:e,block:t=!1,prev:n,next:r,q:a=defer(),q2:s=(e.length?defer():null)}){return{fn:e,block:t,prev:n,next:r,q:a,q2:s}}function deque(){const s=t;if(!s||s.block&&s.prev||s.prev&&s.prev.block||r>=e)return;let o;s.block||r++,t=s.next;try{o=s.fn(s.q2&&s.q2.resolve)}catch(e){return s.q.reject(e),void onDone()}if(s.q2&&s.q2.promise.then(_onDone),o&&o.then){const e=o.then(s.q.resolve,s.q.reject);s.q2||e.then(onDone)}else if(s.q.resolve(o),!s.q2)return void onDone();function onDone(){_onDone()}function _onDone(e){s.prev&&(s.prev.next=s.next),s.next&&(s.next.prev=s.prev),n===s&&(n=s.prev),s.block||r--,a.length--,e&&e(),deque()}deque()}}e.exports={createLock,createLockPool:function(e){const t=new Map;return{read:(e,t)=>op(e,t,"read"),write:(e,t)=>op(e,t,"write"),locks:t};async function op(n,r,a){const s=[],o=[];for(const r of n){let n=t.get(r);n||(n=createLock(e),t.set(r,n));const i={lock:n,scope:r,relase:null};o.push(n[a](e=>{i.release=e})),s.push(i)}let i;await Promise.all(o);try{i=r(r.length&&onDone)}catch(e){throw onDone(),e}return i&&i.then?(r.length||i.then(onDone,onDone),await i):(r.length||onDone(),i);function onDone(){for(const e of s)e.release(()=>{e.lock.length||t.delete(e.scope)});s.length=0}}}}},4:(e,t)=>{"use strict";function percentToByte(e){return String.fromCharCode(parseInt(e.slice(1),16))}function byteToPercent(e){return`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`}Object.defineProperty(t,"__esModule",{value:!0}),t.encode=function(e){return btoa(encodeURIComponent(e).replace(/%[0-9A-F]{2}/g,percentToByte))},t.decode=function(e){return decodeURIComponent(Array.from(atob(e),byteToPercent).join(""))}},664:()=>{e.API={}},337:()=>{e.browser=chrome},944:(e,t,n)=>{"use strict";n.r(t),n.d(t,{LockError:()=>r});class r extends Error{constructor(e){super(`The database is locked. Will expire at ${new Date(e).toLocaleString()}`),this.expire=e,this.name="LockError",Error.captureStackTrace&&Error.captureStackTrace(this,r)}}},814:(e,t,n)=>{"use strict";n.r(t),n.d(t,{RequestError:()=>o,createRequest:()=>createRequest});const{createLock:r}=n(374),a=n(4),{delay:s}=n(423);class o extends Error{constructor(e,t,n=t&&t.status){super(e),this.code=n,this.origin=t,Error.captureStackTrace&&Error.captureStackTrace(this,o)}}function createRequest({fetch:e,cooldown:t=0,getAccessToken:n,username:i,password:c}){const l=r(),d=i||c?`Basic ${a.encode(`${i}:${c}`)}`:null;return e=>l.write(async n=>{try{return await doRequest(e)}finally{t&&e.method&&"GET"!==e.method?setTimeout(n,t):n()}});async function doRequest({path:t,contentType:r,headers:a,format:i,raw:c=!1,...l}){const u={};for(n&&(u.Authorization=`Bearer ${await n()}`),d&&(u.Authorization=d),r&&(u["Content-Type"]=r),Object.assign(u,a);;){const n=await e(t,{headers:u,...l});if(!n.ok){const e=n.headers.get("Retry-After");if(e){const t=Number(e);if(t){await s(1e3*t);continue}}const t=await n.text();throw new o(`failed to fetch [${n.status}]: ${t}`,n)}if(c)return n;if(i)return await n[i]();const r=n.headers.get("Content-Type");return/application\/json/.test(r)?await n.json():await n.text()}}}},423:(e,t,n)=>{"use strict";function debounced(e){let t,n=0;return()=>(n&&clearTimeout(n),n=setTimeout(run),t||(t=defer()),t.promise);function run(){Promise.resolve(e()).then(t.resolve,t.reject),n=0,t=null}function defer(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}}function delay(e){return new Promise(t=>setTimeout(t,e))}n.r(t),n.d(t,{debounced:()=>debounced,delay:()=>delay})},245:(e,t,n)=>{"use strict";function dirname(e){const t=e.replace(/[/\\][^/\\]+[/\\]?$/,"");return t===e?".":t}n.r(t),n.d(t,{dirname:()=>dirname})}},r={};function __webpack_require__(e){var t=r[e];if(void 0!==t)return t.exports;var a=r[e]={exports:{}};return n[e](a,a.exports,__webpack_require__),a.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var n={};__webpack_require__.r(n),__webpack_require__.d(n,{config:()=>config,editSave:()=>editSave,find:()=>find,get:()=>id2style,getAll:()=>getAll,getAllOrdered:()=>getAllOrdered,getByUrl:()=>getByUrl,getCodelessStyles:()=>getCodelessStyles,getEditClientData:()=>getEditClientData,getOrder:()=>getOrder,getRemoteInfo:()=>getRemoteInfo,getSectionsByUrl:()=>getSectionsByUrl,handleSave:()=>handleSave,id2style:()=>id2style,importMany:()=>importMany,install:()=>install,iterStyles:()=>iterStyles,order:()=>Ht,preview:()=>preview,remove:()=>style_manager_remove,save:()=>saveStyle,saveStyle:()=>saveStyle,searchDb:()=>searchDb,setOrder:()=>setOrder,toggle:()=>toggle,toggleOverride:()=>toggleOverride,uuid2style:()=>uuid2style});var r={};__webpack_require__.r(r),__webpack_require__.d(r,{connected:()=>bn,connecting:()=>vn,disconnected:()=>_n,disconnecting:()=>kn,pending:()=>Sn});var a={};__webpack_require__.r(a),__webpack_require__.d(a,{getDriveOptions:()=>getDriveOptions,getStatus:()=>getStatus,getToken:()=>getToken,login:()=>login,putDoc:()=>putDoc,remove:()=>sync_manager_remove,setDriveOptions:()=>setDriveOptions,start:()=>start,stop:()=>stop,syncNow:()=>syncNow});var s={};__webpack_require__.r(s),__webpack_require__.d(s,{checkAllStyles:()=>checkAllStyles,checkStyle:()=>checkStyle,getStates:()=>getStates});var o={};__webpack_require__.r(o),__webpack_require__.d(o,{build:()=>build,buildCode:()=>buildCode,buildMeta:()=>buildMeta,configVars:()=>configVars,editSave:()=>usercss_manager_editSave,find:()=>usercss_manager_find,getInstallCode:()=>getInstallCode,getVersion:()=>getVersion,install:()=>usercss_manager_install,parse:()=>parse});var i={};__webpack_require__.r(i),__webpack_require__.d(i,{deleteStyle:()=>deleteStyle,getEmbeddedMeta:()=>getEmbeddedMeta,getUpdatability:()=>getUpdatability,pingback:()=>pingback,toUsercss:()=>toUsercss});var c={};__webpack_require__.r(c),__webpack_require__.d(c,{publish:()=>publish,revoke:()=>revoke}),__webpack_require__(664);const l=/(R)eceiving end does not exist|The message port closed|moved into back\/forward cache/,saveStack=()=>new Error,d={},u=e.API;let p;function apiPortDisconnect(){const e=chrome.runtime.lastError;if(e)for(const t in d)apiPortResponse({id:t,error:e});p=null}function apiPortResponse({id:e,data:t,error:n}){const r=d[e];if(delete d[e],n){const{err:e}=r;e.message=n.message,n.stack&&(e.stack=n.stack+"\n"+e.stack),r.ko(n)}else r.ok(t)}const f=Object.call.bind({}.hasOwnProperty),stringAsRegExpStr=e=>e.replace(/[{}()[\]\\.+*?^$|]/g,"\\$&"),stringAsRegExp=(e,t)=>new RegExp(stringAsRegExpStr(e),t),promiseWithResolve=e=>Object.assign(new Promise(t=>e=t),{resolve:e}),h=/\/\*!?\s*==userstyle==[\s\S]*?==\/userstyle==\s*\*\//i,g=(()=>{const t=new Map;return Object.assign((n,r,...a)=>{r=+r||0;const s=performance.now()+r;let o=t.get(n);if(o){if(r&&o.time<s)clearTimer(o);else if(o.args.length===a.length&&o.args.every((e,t)=>e===a[t]))return}else t.set(n,o={});o.args=a,o.time=s,o.timer=setTimeout(run,r,n,a,o.resolve=e.keepAlive(promiseWithResolve()).resolve)},{timers:t,run,unregister(e){const n=t.get(e);n&&(clearTimer(n),t.delete(e))}});function clearTimer(e){clearTimeout(e.timer),e.resolve()}async function run(e,n,r){t.delete(e),r(e(...n))}})();function isEmptyObj(e){if(e)for(const t in e)if(f(e,t))return!1;return!0}function mapObj(e,t,n){if(!e)return e;const r={};for(const a of n||Object.keys(e))n&&!(a in e)||(r[a]=t?t(e[a],a,e):e[a]);return r}function tryRegExp(e,t){try{return new RegExp(e,t)}catch{}}function util_tryJSONparse(e){try{if(e)return JSON.parse(e)}catch{}}function tryURL(e){try{if(e)return new URL(e)}catch{}return""}function deepMerge(e,t,n){if(!e||"object"!=typeof e)return e;if(Array.isArray(e))if(t&&n)for(const n of e)t.push(deepMerge(n));else t=Array.prototype.map.call(e,util_deepCopy);else{t||(t={});for(const[n,r]of Object.entries(e))t[n]=deepMerge(r,t[n])}return t}function util_deepCopy(e){return deepMerge(e)}function deepEqual(e,t,n){if(!e||!t||e===t)return e===t;const r=typeof e;if(r!==typeof t)return!1;if("object"!==r)return e===t;if(Array.isArray(e))return Array.isArray(t)&&e.length===t.length&&e.every((e,r)=>deepEqual(e,t[r],n));for(const r in e)if(!(!f(e,r)||n&&n.includes(r))){if(!f(t,r))return!1;if(!deepEqual(e[r],t[r],n))return!1}for(const r in t)if(!(!f(t,r)||n&&n.includes(r)||f(e,r)))return!1;return!0}async function fetchText(e,t){return(await fetch(e,t)).text()}__webpack_require__(337);const m=navigator.userAgentData,y=m||navigator.userAgent,w=m?m.brands.map(e=>`${e.brand}/${e.version}`).join(" "):y,b=m?m.platform:y,v=+w.match(/Chrom\w*\/(\d+)|$/)[1],_=v,k=v?NaN:+w.match(/Firefox\w*\/(\d+)|$/)[1],S=(w.match(/(Opera|OPR)\w*\/(\d+)|$/)[1],m?m.mobile:/Android/.test(y)),x=/Windows/.test(b),I=+w.match(/Vivaldi\w*\/(\d+)|$/)[1],D=chrome.runtime.getURL(""),T=D+"popup.html",E="install-usercss.html",C="/js/worker.js",O=/^(https:\/\/)(?:update\.)?((?:greasy|sleazy)fork\.org\/scripts\/)(\d+)[^/]*\/code\/[^/]*\.user\.css$|$/,P="https://userstyles.org/",M="https://gateway.userstyles.org/styles/getStyle",U="https://userstyles.org/styles/chrome/",R=["https://cdn.jsdelivr.net/gh/uso-archive/data@flomaster/data/","https://raw.githubusercontent.com/uso-archive/data/flomaster/data/","https://cdn.jsdelivr.net/gh/33kk/uso-archive@flomaster/data/","https://raw.githubusercontent.com/33kk/uso-archive/flomaster/data/"],j="https://userstyles.world/",extractUsoaId=e=>e&&R.some(t=>e.startsWith(t))&&+e.match(/\/(\d+)\.user\.css|$/)[1],extractUswId=e=>e&&e.startsWith(j)&&+e.match(/\/(\d+)\.user\.css|$/)[1],makeInstallUrl=(e,t)=>"usoa"===e||!t&&(t=extractUsoaId(e))?`https://uso.kkx.one/style/${t}`:"usw"===e||!t&&(t=extractUswId(e))?`${j}style/${t}`:"gf"===e||!t&&(t=O.exec(e))?t[1]+t[2]+t[3]:"",makeUpdateUrl=(e,t)=>"usoa"===e||!t&&(t=extractUsoaId(e))?`${R[0]}usercss/${t}.user.css`:"usw"===e||!t&&(t=extractUswId(e))?`${j}api/style/${t}.user.css`:"",$=RegExp.prototype.test,A=$.bind(new RegExp(`^(?:(?:ht|f)tps?:|file:|${D})`)),q=$.bind(/^file:|^https?:\/\/([^/]+@)?(localhost|127\.0\.0\.1)(:\d+)?\//),L=chrome.runtime.getManifest(),N=L.icons[16].replace(D,""),B=N.slice(0,N.lastIndexOf("/")+1),W=N.slice(N.lastIndexOf(".")),F=browser.windows,V=chrome.storage.sync.onChanged||chrome.storage.onChanged,getActiveTab=async()=>(await browser.tabs.query({currentWindow:!0,active:!0}))[0]||F&&(await browser.tabs.query({windowId:(await F.getCurrent()).id,active:!0}))[0],ignoreChromeError=()=>chrome.runtime.lastError,toggleListener=(e,t,...n)=>t?e.addListener(...n):e.removeListener(n[0]);let H,z;e._deepCopy=util_deepCopy;const J={__proto__:null,disableAll:!1,exposeIframes:!1,exposeStyleName:!1,keepAlive:0,newStyleAsUsercss:!1,openEditInWindow:!1,"openEditInWindow.popup":!1,patchCsp:!1,"show-badge":!0,styleViaASS:!1,styleViaXhr:!0,urlInstaller:!0,windowPosition:{},"config.autosave":!0,"schemeSwitcher.enabled":"system","schemeSwitcher.nightStart":"18:00","schemeSwitcher.nightEnd":"06:00","popup.enabledFirst":!0,"popup.stylesFirst":!0,"popup.autoResort":!1,"popup.borders":!1,"popup.findSort":"w","manage.onlyEnabled":!1,"manage.onlyLocal":!1,"manage.onlyUsercss":!1,"manage.onlyEnabled.invert":!1,"manage.onlyLocal.invert":!1,"manage.onlyUsercss.invert":!1,"manage.actions.expanded":!0,"manage.backup.expanded":!0,"manage.filters.expanded":!0,"manage.minColumnWidth":750,"manage.newUI":!0,"manage.newUI.favicons":!0,"manage.newUI.faviconsGray":!1,"manage.newUI.targets":3,"manage.newUI.sort":"title,asc","manage.searchMode":"meta","editor.options":{},"editor.toc.expanded":!0,"editor.options.expanded":!0,"editor.lint.expanded":!0,"editor.publish.expanded":!0,"editor.lineWrapping":!0,"editor.smartIndent":!0,"editor.indentWithTabs":!1,"editor.tabSize":4,"editor.keyMap":"default","editor.theme":"default","editor.beautify":{selector_separator_newline:!0,newline_before_open_brace:!1,newline_after_open_brace:!0,newline_between_properties:!0,newline_before_close_brace:!0,newline_between_rules:!1,preserve_newlines:!0,end_with_newline:!1,indent_conditional:!0,indent_mozdoc:!0,space_around_combinator:!0,space_around_cmp:!1},"editor.beautify.hotkey":"","editor.lintDelay":300,"editor.linter":"csslint","editor.lintReportDelay":500,"editor.matchHighlight":"token","editor.autoCloseBrackets":!0,"editor.autocompleteOnTyping":!1,"editor.contextDelete":!1,"editor.selectByTokens":!0,"editor.arrowKeysTraverse":!0,"editor.appliesToLineWidget":!0,"editor.autosaveDraft":10,"editor.livePreview":!0,"editor.livePreview.delay":.2,"editor.targetsFirst":!0,"editor.colorpicker":!0,"editor.colorpicker.hexUppercase":!1,"editor.colorpicker.hotkey":"","editor.colorpicker.color":"","editor.colorpicker.maxHeight":300,"hotkey._execute_browser_action":"","hotkey.openManage":"","hotkey.styleDisableAll":"","sync.enabled":"none",iconset:-1,badgeDisabled:"#8B0000",badgeNormal:"#006666","headerWidth.edit":280,"headerWidth.install":280,"headerWidth.manage":280,"popup.search.globals":!1,popupWidth:246,popupWidthMax:280,updateInterval:24,updateOnlyEnabled:!1},K=console.warn.bind(console,'Unknown preference "%s"'),G=util_deepCopy(J),Q={},X="settings",Z=(new Proxy({},{get:(e,t)=>util_deepCopy(J[t])}),Object.keys(J),e=>{const{[e]:t=K(e)}=G;return t&&"object"==typeof t?util_deepCopy(t):t});let set=(e,t,n)=>{const r=G[e],a=typeof J[e];if(!a)return K(e);if(a!==typeof t&&(t="string"===a?`${t}`:"number"===a?+t||0:"boolean"===a?"true"===t||"false"!==t&&!!t:null),t===r||"object"===a&&deepEqual(t,r))return;G[e]=t;const s=Q[e];if(s)for(const n of s)n(e,t);return!0};const subscribe=(e,t,n)=>{if(!t)return;let r;for(const a of Array.isArray(e)?new Set(e):[e])a in J?((Q[a]??=new Set).add(t),n&&(H?(r??=[]).push(a):t(a,G[a]))):K(a);return r?H.then(()=>{for(const e of r)t(e,G[e],!0)}):void 0},unsubscribe=(e,t)=>{for(const n of Array.isArray(e)?e:[e]){const e=Q[n];e&&(e.delete(t),e.size||delete Q[n])}};function setAll(e,t){if(H=!1,t){for(const n in t)!(n in e)&&n in J&&set(n,J[n],!0);for(const t in e||(e={}))set(t,e[t],!0)||delete e[t]}else Object.assign(G,e)}H=new Promise(e=>z=e),H.set=(...e)=>z(setAll(...e)),V.addListener((e,t)=>{if(H)return;const n=(!t||"sync"===t)&&e[X];n&&setAll(n.newValue,n.oldValue)});const Y=H||Promise.resolve();H||(Y.then=e=>e());const ee=promiseWithResolve(),safeTimeout=(t,n,...r)=>setTimeout(safeTimeoutResolve,n,t,r,e.keepAlive(promiseWithResolve()).resolve),safeTimeoutResolve=(e,t,n)=>n(e(...t)),te=Object.assign(new Map,{custom:{},addCustom(e,{get:t=()=>e,set:n}){Object.defineProperty(te.custom,e._id,{get:t,set:n})}});let ne,re=!(!F||!_)&&(async()=>{const e=(await F.getAll())[0]||await new Promise(e=>F.onCreated.addListener(function onCreated(t){F.onCreated.removeListener(onCreated),e(t)}));return re=e&&!(!e.vivExtData&&!e.extData),re})();t._ready=ee;let ae,se,oe,ie=0;async function keepAliveUntilSettled(e){ne=e,null==se&&await ee,ae||reschedule();do{await Promise.allSettled(ne)}while(ne?.splice(0,e.length)&&ne.length);ne=null,ie=performance.now()}async function reschedule(){(ne||se<0?isUserActiveInBrowser(!0):se&&performance.now()<ie+se&&await isUserActiveInBrowser())?ae??=setInterval(reschedule,25e3):ae&&(clearInterval(ae),ae=null)}async function isUserActiveInBrowser(e){return("idle"!==await chrome.idle.queryState(oe)||e)&&(e||(await chrome.windows.getAll({})).some(e=>e.focused))}e.keepAlive=function(e){return e instanceof Promise?ne?ne.push(e):keepAliveUntilSettled([e]):ie=performance.now(),e},subscribe("keepAlive",(e,t)=>{oe=Math.max(30,60*t|0||0),se=6e4*t,ae&&(se||ne)||reschedule()},!0);const ce={__proto:null,all:["both","tab","extension"],extension:["both","extension"],tab:["both","tab"]},le={both:new Set,tab:new Set,extension:new Set};function _execute(t,...n){let r;for(const e of ce[t]||ce.all)for(const t of le[e]){let e;try{e=t(...n)}catch(t){e=Promise.reject(t)}void 0!==e&&void 0===r&&(r=e)}return e.keepAlive(r)}function wrapData(e){return{data:e}}function wrapError(e){return{error:Object.assign({message:e.message||`${e}`,stack:e.stack},e)}}chrome.runtime.onMessage.addListener(function({data:e,target:t},n,r){"backgroundReady"===e.method&&p&&apiPortDisconnect();const a=_execute(t,e,n);if(a instanceof Promise)return a.then(wrapData,wrapError).then(r),!0;void 0!==a&&r(wrapData(a))});const NOP=()=>{};let de,ue;function createPortProxy(e,t){let n;const init=(...r)=>(n??=createPortExec(e,t))(...r);return new Proxy({},{get:(e,t)=>function(...e){return(n||init).call(this,t,...e)}})}function createPortExec(e,{lock:t,once:n}={}){let r,a,s,o,i=0;return async function(...e){const t=[(new Error).stack],o=new Promise((e,n)=>t.push(e,n));return(a??=initPort()).then&&(a=await a),(n?s:a).postMessage({args:e,id:++i},n||(Array.isArray(this)?this:void 0)),r.set(i,t),o};async function initPort(){if("string"==typeof e?(t=e,s=new SharedWorker(e),s.onerror=console.error,s=s.port):(s="function"==typeof e?e():e,s.then&&(s=await s)),s instanceof MessagePort)a=s;else{const e=new MessageChannel;a=e.port1,n?n=[e.port2]:s.postMessage({lock:t},[e.port2])}return a.onmessage=onMessage,a.onmessageerror=onMessageError,r=new Map,i=0,a}function onMessage({data:e}){o||n||trackTarget(r);const{id:t,res:c,err:l}=e.id?e:JSON.parse(e),[d,u,p]=r.get(t);r.delete(t),t===i&&--i,l?(l.stack+="\n"+d,p(l)):u(c),n&&(a.close(),r=a=s=null)}async function trackTarget(e){o=!0,await navigator.locks.request(t,NOP),o=!1;for(const[t,,n]of e.values()){const e=new Error("Target disconnected");e.stack=t,n(e)}r===e&&(a=r=s=null)}}function onMessageError({data:e,source:t}){console.warn("Non-cloneable data",e),t.postMessage(JSON.stringify(e))}navigator.serviceWorker;const{createRequest:pe}=__webpack_require__(814),{createRequest:fe}=__webpack_require__(814),{createRequest:he,RequestError:ge}=__webpack_require__(814),{LockError:me}=__webpack_require__(944),{dirname:ye}=__webpack_require__(245),{createRequest:we}=__webpack_require__(814),{createLock:be}=__webpack_require__(374),{LockError:ve}=__webpack_require__(944),{delay:_e,debounced:ke}=__webpack_require__(423);function buildDrive(e){const t=Object.create(e);return t.get=async t=>JSON.parse(await e.get(t)),t.put=async(t,n)=>await e.put(t,JSON.stringify(n)),t.post=async(t,n)=>await e.post(t,JSON.stringify(n)),t.isInit=!1,t.acquireLock||(t.acquireLock=async function(e){try{await this.post("lock.json",{expire:Date.now()+60*e*1e3})}catch(e){if("EEXIST"!==e.code)throw e;const t=await this.get("lock.json");if(Date.now()>t.expire)throw await this.delete("lock.json"),new Error("Found expired lock, please try again");throw new ve(t.expire)}},t.releaseLock=async function(){await this.delete("lock.json")}),t.getMeta||(t.getMeta=async function(){try{return await this.get("meta.json")}catch(e){if("ENOENT"===e.code||404===e.code)return{};throw e}},t.putMeta=async function(e){await this.put("meta.json",e)}),t.peekChanges||(t.peekChanges=async function(e){return(await this.getMeta()).lastChange!==e.lastChange}),t}function dbToCloud({onGet:e,onPut:t,onDelete:n,onFirstSync:r,onWarn:a=console.error,onProgress:s,compareRevision:o,getState:i,setState:c,lockExpire:l=60,retryMaxAttempts:d=5,retryExp:u=1.5,retryDelay:p=10}){let f,h,g;const m=new Map,y=ke(()=>c(f,h)),w=new Map,b=be();return{use:function(e){f=buildDrive(e)},init:function(){return b.write(async()=>{if(!h||!h.enabled){if(!f)throw new Error("cloud drive is undefined");h=await i(f)||{},h.enabled=!0,h.queue||(h.queue=[])}})},uninit:function(){return b.write(async()=>{h&&h.enabled&&(h=g=null,m.clear(),w.clear(),f.uninit&&f.isInit&&(await f.uninit(),f.isInit=!1),await y())})},put:function(e,t){h&&h.enabled&&(h.queue.push({_id:e,_rev:t,action:"put"}),y())},delete:function(e,t){h&&h.enabled&&(h.queue.push({_id:e,_rev:t,action:"delete"}),y())},syncNow:function(e){return b.write(async()=>{if(!h||!h.enabled)throw new Error("Cannot sync now, the sync is not enabled");f.init&&!f.isInit&&(await f.init(),f.isInit=!0),null==h.lastChange&&await r(),await _syncNow(e)})},drive:()=>f,isInit:()=>Boolean(h&&h.enabled)};async function syncPull(){if(g=await f.getMeta(),!g.lastChange||g.lastChange===h.lastChange)return;let e=[];if(h.lastChange){const t=Math.floor((g.lastChange-1)/100);let n=Math.floor(h.lastChange/100);for(;n<=t;){const t=await f.get(`changes/${n}.json`);m.set(n,t),e=e.concat(t),n++}e=e.slice(h.lastChange%100)}else e=(await f.list("docs")).map(e=>({action:"put",_id:e.slice(0,-5)}));const r=new Map;for(const t of e)r.set(t._id,t);let o=0;for(const[e,i]of r){let c,l;if(s&&s({phase:"pull",total:r.size,loaded:o,change:i}),"delete"===i.action)await n(e,i._rev);else if("put"===i.action){try{({doc:c,_rev:l}=await f.get(`docs/${e}.json`))}catch(t){if("ENOENT"===t.code||404===t.code){a(`Cannot find ${e}. Is it deleted without updating the history?`),o++;continue}throw t}await t(c)}const d=i._rev||l;d&&w.set(e,d),o++}h.lastChange=g.lastChange,await y()}async function syncPush(){if(!h.queue.length)return;const t=h.queue.slice(),n=new Map;for(const e of t)n.set(e._id,e);const r=[];for(const e of n.values()){const t=w.get(e._id);void 0!==t&&o(e._rev,t)<=0||r.push(e)}let a,i,c=0;for(const t of r){if(s&&s({phase:"push",loaded:c,total:r.length,change:t}),"delete"===t.action)await f.delete(`docs/${t._id}.json`);else if("put"===t.action){const n=await e(t._id,t._rev);await f.put(`docs/${t._id}.json`,{doc:n,_rev:t._rev})}w.set(t._id,t._rev),c++}if(g.lastChange){i=Math.floor(g.lastChange/100);const e=g.lastChange%100;a=e?m.get(i)||await f.get(`changes/${i}.json`):[],a=a.slice(0,e).concat(r)}else i=0,a=r;for(let e=0;100*e<a.length;e++){const t=a.slice(100*e,100*(e+1));await f.put(`changes/${i+e}.json`,t),m.set(i+e,t)}g.lastChange=(g.lastChange||0)+r.length,await f.putMeta(g),h.queue=h.queue.slice(t.length),h.lastChange=g.lastChange,await y()}async function sync(){let e,t=0,n=p;for(;;){try{await f.acquireLock(l);break}catch(t){if("LockError"!==t.name)throw t;e=t}if(t++,t>=d)throw e;await _e(1e3*n),n*=u}try{await syncPull(),await syncPush()}finally{await f.releaseLock()}}async function _syncNow(e=!0){s&&s({phase:"start"});try{if(!h.queue.length&&e&&g&&!await f.peekChanges(g))return;await sync()}finally{s&&s({phase:"end"})}}}const Se={dropbox:function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch}){const r=pe({fetch:n,getAccessToken:t});return{name:"dropbox",get:async function(e){const t={path:`/${e}`};try{return await r({path:`https://content.dropboxapi.com/2/files/download?${stringifyParams(t)}`,format:"text"})}catch(e){throw 409===e.code&&e.message.includes("not_found")&&(e.code="ENOENT"),e}},put,post:async function(e,t){try{return await put(e,t,"add")}catch(e){throw 409===e.code&&e.message.includes("conflict")&&(e.code="EEXIST"),e}},delete:async function(e){try{await requestRPC({path:"files/delete_v2",body:{path:`/${e}`}})}catch(e){if(409===e.code&&e.message.includes("not_found"))return;throw e}},list:async function(e){const t=[];let n=await requestRPC({path:"files/list_folder",body:{path:`/${e}`}});for(const e of n.entries)t.push(e.name);if(!n.has_more)return t;for(;n.has_more;){n=await requestRPC({path:"files/list_folder/continue",body:{cursor:n.cursor}});for(const e of n.entries)t.push(e.name)}return t}};function requestRPC({path:e,body:t,...n}){return r({method:"POST",path:`https://api.dropboxapi.com/2/${e}`,contentType:"application/json",body:JSON.stringify(t),...n})}function stringifyParams(e){const t=new URLSearchParams;return t.set("arg",JSON.stringify(e)),t.toString()}async function put(e,t,n="overwrite"){const a={path:`/${e}`,mode:n,autorename:!1,mute:!0};await r({path:`https://content.dropboxapi.com/2/files/upload?${stringifyParams(a)}`,method:"POST",contentType:"application/octet-stream",body:t})}},onedrive:function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch}){const r=fe({fetch:n,getAccessToken:t});return{name:"onedrive",get:async function(e){return await query({path:`:/${e}:/content`,format:"text"})},put:async function(e,t){await query({method:"PUT",path:`:/${e}:/content`,headers:{"Content-Type":"text/plain"},body:t})},post:async function(e,t){try{await query({method:"PUT",path:`:/${e}:/content?@microsoft.graph.conflictBehavior=fail`,headers:{"Content-Type":"text/plain"},body:t})}catch(e){throw 409===e.code&&e.message.includes("nameAlreadyExists")&&(e.code="EEXIST"),e}},delete:async function(e){try{await query({method:"DELETE",path:`:/${e}:`})}catch(e){if(404===e.code)return;throw e}},list:async function(e){e&&(e=`:/${e}:`);let t=await query({path:`${e}/children?select=name`}),n=t.value.map(e=>e.name);for(;t["@odata.nextLink"];)t=await r({path:t["@odata.nextLink"]}),n=n.concat(t.value.map(e=>e.name));return n}};async function query(e){return e.path=`https://graph.microsoft.com/v1.0/me/drive/special/approot${e.path}`,await r(e)}},google:function({getAccessToken:t,fetch:n=("undefined"!=typeof self?self:e).fetch,FormData:r=("undefined"!=typeof self?self:e).FormData,Blob:a=("undefined"!=typeof self?self:e).Blob}){const s=he({fetch:n,getAccessToken:t}),o=new Map;let i;return{name:"google",get:async function(e){let t=o.get(e);if(!t&&(await updateMeta(`name = '${e}'`),t=o.get(e),!t))throw new ge(`metaCache doesn't contain ${e}`,null,"ENOENT");try{return await s({path:`https://www.googleapis.com/drive/v3/files/${t.id}?alt=media`})}catch(e){throw 404===e.code&&(e.code="ENOENT"),e}},put:async function(e,t){if(!o.has(e))return await post(e,t);const n=o.get(e),r=await queryPatch(n.id,t);n.headRevisionId=r.headRevisionId},post,delete:async function(e){const t=o.get(e);if(t)try{await s({method:"DELETE",path:`https://www.googleapis.com/drive/v3/files/${t.id}`})}catch(e){if(404===e.code)return;throw e}},list:async function(e){return[...o.values()].filter(t=>t.name.startsWith(e+"/")).map(e=>e.name.split("/")[1])},init:async function(){await updateMeta(),o.has("lock.json")||await post("lock.json","{}"),o.has("meta.json")||await post("meta.json","{}")},acquireLock:async function(e){const t=o.get("lock.json"),{headRevisionId:n}=await queryPatch(t.id,JSON.stringify({expire:Date.now()+60*e*1e3})),r=await s({path:`https://www.googleapis.com/drive/v3/files/${t.id}/revisions?fields=revisions(id)`});for(let e=1;e<r.revisions.length;e++){const a=r.revisions[e].id;if(a===n)return void(i=n);const o=JSON.parse(await s({path:`https://www.googleapis.com/drive/v3/files/${t.id}/revisions/${a}?alt=media`}));if(o.expire>Date.now())throw await revDelete(t.id,n),new me(o.expire);await revDelete(t.id,a)}throw new Error("cannot find lock revision")},releaseLock:async function(){const e=o.get("lock.json");await revDelete(e.id,i),i=null},fileMetaCache:o};async function revDelete(e,t){await s({method:"DELETE",path:`https://www.googleapis.com/drive/v3/files/${e}/revisions/${t}`})}async function queryList(e,t){e="https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&fields=nextPageToken,files(id,name,headRevisionId)"+(e?"&"+e:"");let n=await s({path:e});for(t(n);n.nextPageToken;)n=await s({path:`${e}&pageToken=${n.nextPageToken}`}),t(n)}async function queryPatch(e,t){return await s({method:"PATCH",path:`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media&fields=headRevisionId`,headers:{"Content-Type":"text/plain"},body:t})}async function updateMeta(e){e&&(e=`q=${encodeURIComponent(e)}`),await queryList(e,e=>{for(const t of e.files)o.set(t.name,t)})}async function post(e,t){const n=new r,i={name:e,parents:["appDataFolder"]};n.append("metadata",new a([JSON.stringify(i)],{type:"application/json; charset=UTF-8"})),n.append("media",new a([t],{type:"text/plain"}));const c=await s({method:"POST",path:"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,headRevisionId",body:n});o.set(c.name,c)}},webdav:!1},xe="offscreen.html",Ie=D+xe,De=e.offscreen=createPortProxy(async function(){for(let e;;e=!0){for(const e of await self.clients.matchAll({includeUncontrolled:!0}))if(e.url===Ie)return e;if(e)return;try{await chrome.offscreen.createDocument({url:Ie,reasons:["BLOBS","DOM_PARSER","MATCH_MEDIA","WORKERS"],justification:"ManifestV3 requirement"})}catch(e){if(!e.message.startsWith("Only a single offscreen"))throw e}}},{lock:"/"+xe}),Te={async getValue(e){return(await this.get(e))[e]},async setValue(e,t){await this.set({[e]:t})}},Ee=Object.assign(browser.storage.local,Te);chrome.storage.session;let exec=async function(e,t,...n){const r=t.startsWith("get")?"readonly":"readwrite",a=getStoreName(e);return("putMany"===t?putMany:storeRequest)((await db_open(e)).transaction([a],r).objectStore(a),t,...n)};const Ce="stylish",Oe={},getStoreName=e=>e===Ce?"styles":"data",Pe={},Me={},Ue={get:({dbName:e},t)=>(e===Ce?exec:cachedExec).bind(null,e,t)},getDbProxy=(e,t)=>Me[e]??=(Oe[e]=!!t,new Proxy({dbName:e},Ue)),Re=getDbProxy(Ce,!0);async function cachedExec(e,t,n,r){const a=Pe[e]||(Pe[e]={}),s="get"===t&&n in a?a[n]:await exec(...arguments);return"get"===t?a[n]=util_deepCopy(s):"put"===t?a[Oe[e]?n.id:r]=util_deepCopy(n):"delete"===t&&delete a[n],s}function storeRequest(e,t,...n){return new Promise((r,a)=>{const s=e[t](...n);s.onsuccess=()=>r(s.result),s.onerror=a})}function putMany(e,t,n){return Promise.all(n.map(t=>storeRequest(e,"put",t)))}function db_open(e){return new Promise((t,n)=>{const r=indexedDB.open(e,2);r.onsuccess=e=>t(create(e)),r.onerror=n,r.onupgradeneeded=create})}function create(e){const t=e.target.result,n=t.name,r=getStoreName(n);if(!t.objectStoreNames.contains(r)){if("success"===e.type)return t.close(),new Promise(e=>{indexedDB.deleteDatabase(n).onsuccess=()=>{e(db_open(n))}});t.createObjectStore(r,Oe[n]?{keyPath:"id",autoIncrement:!0}:void 0)}return t}Object.assign(u,{drafts:getDbProxy("drafts"),prefsDb:getDbProxy(X)});const je=getDbProxy("state",!0),$e=new Map,Ae=Promise.all([je.getAll(),chrome.tabs.query({})]).then(([e,t])=>{const n={};for(const t of e)$e.set(t.id,t);for(const e of t)n[e.id]=e;return[$e,t,n]}),qe=$e.get.bind($e),state_db_set=(e,t)=>(!t||isEmptyObjExceptId(t)?remove(e):(t.id=e,$e.set(e,t),Ne||(Le={},Ne=safeTimeout(updateSessionStorage,1e4)),Le[e]=t),t),remove=t=>{$e.has(t)&&($e.delete(t),Le&&delete Le[t],e.keepAlive(je.delete(t)))};let Le,Ne;function isEmptyObjExceptId(e){for(const t in e)if("id"!==t&&f(e,t))return!1;return!0}function updateSessionStorage(){const e=Le;if(Ne=Le=null,!isEmptyObj(e))return je.putMany(Object.values(e))}const Be=new Set,We="schemeSwitcher.nightStart",Fe="schemeSwitcher.nightEnd",Ve="dark",He="light",ze="never",Je="system",Ke="time",Ge={[ze]:!1,[Ve]:!0,[He]:!1,[Je]:!1,[Ke]:!1},Qe=[Ve,He],Xe=update.bind(null,Je);let Ze,Ye=!1;function color_scheme_onChange(e,t){Be.add(e),t&&(Ze?e(Ye):Y.then(()=>e(Ye)))}function shouldIncludeStyle({preferScheme:e}){return Ze===ze||e!==Ve&&e!==He||Ye===(e===Ve)}function calcTime(e){const[t,n]=Z(e).split(":");return 1e3*(3600*t+60*n)}function createAlarm(e,t){const n=new Date,[r,a]=t.split(":");n.setHours(r,a,0,0),n.getTime()<Date.now()&&n.setDate(n.getDate()+1),chrome.alarms.create(e,{when:n.getTime(),periodInMinutes:1440})}function onNightChanged(e){if(!0!==e)return g(onNightChanged,0,!0);updateTimePreferDark(),createAlarm(We,Z(We)),createAlarm(Fe,Z(Fe))}function updateTimePreferDark(){const e=Date.now()-(new Date).setHours(0,0,0,0),t=calcTime(We),n=calcTime(Fe);update(Ke,t>n?e>=t||e<n:e>=t&&e<n)}function update(e,t){if(e){if(Ge[e]===t)return;Ge[e]=t}if(t=Ge[Ze],Ye!==t){Ye=t;for(const e of Be)e(Ye);e=!0}e&&state_db_set(Ve,{1:Ye,2:Ge})}chrome.alarms.onAlarm.addListener(async function({name:e}){e!==We&&e!==Fe||(Ze||await Y,updateTimePreferDark())}),subscribe("schemeSwitcher.enabled",(e,t,n)=>{Ze=t,n&&(e=qe(Ve))&&(Ye=e[1],Object.assign(Ge,e[2])),t===Ke?subscribe([We,Fe],onNightChanged,!0):(unsubscribe([We,Fe],onNightChanged),chrome.alarms.clear(We),chrome.alarms.clear(Fe)),update()},!0);const et=new Set,tt=chrome.webNavigation,nt={url:[{schemes:["http","https","file","ftp","ftps"]}]},rt="committed";let at={};async function onNavigation(e){if(!_||e.timeStamp!==at.timeStamp||!deepEqual(e,at)){if(at=e,this[0]===rt){const{tabId:t,frameId:n}=e,r=getStyleIds(t);if(r)if(n)delete r[n];else for(const e in r)delete r[e]}for(const t of et)t(e,this[0])}}function onFakeNavigation(e){onNavigation.call(this,e);const{tabId:t}=e;if(!tab_manager_get(t))return;const{url:n,frameId:r,documentId:a}=e;sendTab(t,{method:"urlChanged",iid:!1,url:n},{documentId:a})}tt.onCommitted.addListener(onNavigation.bind([rt]),nt),tt.onHistoryStateUpdated.addListener(onFakeNavigation.bind(["history"]),nt),tt.onReferenceFragmentUpdated.addListener(onFakeNavigation.bind(["hash"]),nt);const st=new Set,ot=new Set,it=new Map,tab_manager_get=(e,...t)=>{let n=it.get(e);for(let e=0;n&&e<t.length;e++)n=n[t[e]];return n},getStyleIds=e=>it.get(e)?.styleIds||!1,ct=it.keys.bind(it),tab_manager_set=(e,...t)=>{const n=t.pop(),r=t.pop(),a=void 0===n;let s=it.get(e),o=s;if(!s){if(a)return;it.set(e,s=o={})}for(let e,n=0;s&&n<t.length;n++)s=s[e=t[n]]||!a&&(s[e]={});a?s&&delete s[r]:s[r]=n,state_db_set(e,o)},tab_manager_remove=e=>{it.delete(e),remove(e)};async function onPortDisconnected(e){ignoreChromeError();const{sender:t}=e,n=t.tab.id,r=t.frameId;for(const t of ot)t(n,r,e);if(!r)try{await new Promise(e=>setTimeout(e,1e3)),it.has(n)&&await chrome.tabs.get(n)}catch{tab_manager_remove(n)}}async function broadcast(e,{onlyIfStyled:t,getData:n}={}){const r=[];n&&!(e=n())||r.push(broadcastExtension(e,"both"));const a=(await browser.tabs.query({})).sort((e,t)=>t.active-e.active);for(const s of a)s.discarded||t&&!getStyleIds(s.id)||(s.pendingUrl||s.url||"").startsWith(D)||n&&!(e=n(s))||r.push(sendTab(s.id,e));return Promise.all(r)}function broadcastExtension(e,t="extension"){return unwrap(browser.runtime.sendMessage({data:e,target:t}))}function pingTab(e,t=0){return sendTab(e,{method:"ping"},{frameId:t})}function sendTab(e,t,n,r="tab"){return unwrap(browser.tabs.sendMessage(e,{data:t,target:r},n),n?.frameId?-1:e)}async function unwrap(e,t){const n=saveStack();let r,a;try{if(({data:r,error:a}=await e||{}),!a)return r}catch(e){if(a=e,l.test(n.message=e.message))return t>=0&&RegExp.$1&&tab_manager_remove(t),r}return a.stack&&(n.stack=a.stack+"\n"+n.stack),Promise.reject(n)}async function makePopupData(){let e=await getActiveTab();k&&"loading"===e.status&&"about:blank"===e.url&&(e=await u.waitForTabUrl(e.id));let n=e.pendingUrl||e.url||"";const r=n.startsWith(D),[a,s]=await Promise.all([r||pingTab(e.id),r&&_&&getAllFrames(n,e)||browser.webNavigation.getAllFrames({tabId:e.id})]),o=new Map(s.map(e=>[e.frameId,e])),i=new Map([[0,o.get(0)||{frameId:0,url:""}]]),c=new Set(["about:blank"]);o.delete(0);let l=0;for(;o.size!==l;){for(const[e,t]of o)i.has(t.parentFrameId)&&(o.delete(e),t.errorOccurred||i.set(e,t),"about:blank"===t.url&&(t.url=i.get(t.parentFrameId).url));l=o.size}s.length=0;for(const e of[i,o])for(const t of e.values()){const e=t.url||(t.url="");t.isDupe=c.has(e),c.add(e),s.push(t)}s[0].url=n;const d=A(n);if(d){t._ready.resolve&&await t._ready;let e=[];for(const t of s)t.url&&!t.isDupe&&(t.stylesIdx=e.push(t.styles=u.styles.getByUrl(t.url))-1)}return[s,a,e,d]}async function getAllFrames(e,{id:t}){let n;return n=await chrome.runtime.getContexts({tabIds:[t]}),n=n[1]?.documentUrl,[{frameId:0,url:e},n&&{frameId:1,parentFrameId:0,url:n}].filter(Boolean)}ee.then(()=>{et.add(({tabId:e,frameId:t,url:n})=>{if(t)return;let r,a;(r=it.get(e))?a=r.url:it.set(e,r={}),r.url=n,state_db_set(e,r);for(const t of st)t(e,n,a)})}),Ae?.then(([e,t])=>{for(const{id:n,url:r}of t)if(A(r)){let t=e.get(n);(t?t.url!==r:t={})&&(t.url=r,state_db_set(n,t)),it.set(n,t)}for(const t of e.keys())+t>=0&&!it.has(t)&&remove(t)}),chrome.runtime.onConnect.addListener(e=>{"apply"===e.name&&e.onDisconnect.addListener(onPortDisconnected)});for(var lt=0,dt={},ut=String.fromCharCode,pt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+",ft=(pt+"/=").split(""),ht=(pt+"-$").split("");lt<65;)lt>62&&(dt[ht[lt].charCodeAt(0)]=lt),dt[ft[lt].charCodeAt(0)]=lt++;function _decompress(e,t,n){for(var r,a=[0,1,2],s=4,o=4,i=3,c="",l=[],d="",u=0,p=2,f=0,h=n(0),g=t,m=1;f!=p;)u+=(h>>--g&1)<<f++,0==g&&(g=t,h=n(m++));if(2==u)return"";for(p=8*u+8,u=f=0;f!=p;)u+=(h>>--g&1)<<f++,0==g&&(g=t,h=n(m++));for(r=ut(u),a[3]=r,d=r,l.push(r);m<=e;){for(p=i,u=f=0;f!=p;)u+=(h>>--g&1)<<f++,0==g&&(g=t,h=n(m++));if(u<2){for(p=8+8*u,u=f=0;f!=p;)u+=(h>>--g&1)<<f++,0==g&&(g=t,h=n(m++));a[o]=ut(u),u=o++,0==--s&&(s=1<<i++)}else if(2==u)return l.join("");if(u>a.length)return null;c=u<a.length?a[u]:d+d.charAt(0),l.push(c),a[o++]=d+c.charAt(0),d=c,0==--s&&(s=1<<i++)}return""}const gt=browser.storage.sync,mt=gt.get.bind(gt),yt=gt.set.bind(gt),getValue=async e=>(await mt(e))[e],setValue=(e,t)=>yt({[e]:t});async function getLZValue(e){return util_tryJSONparse(null==(t=(await mt(e))[e])?"":""==t?null:_decompress(t.length,15,function(e){return t.charCodeAt(e)-32}));var t}const wt={},bt=set,updateStorage=()=>setValue(X,wt),vt={get:()=>wt,set:(_t=(e,t,...n)=>{if(bt(e,t,...n)){const n=J[e];if(t===n||t&&"object"==typeof n&&deepEqual(t,n)){if(!(e in wt))return;delete wt[e]}else wt[e]=t;return g(updateStorage),!0}},set=_t)};var _t;(async()=>{let e=getValue(X);var t;[e]=await Promise.all([e,Ae]),Y.set("object"==typeof(t=e)&&t?util_deepCopy(e):{},{}),deepEqual(e,wt)||ee.then(updateStorage)})();const kt=/\s+|\/\*([^*]+|\*(?!\/))*(\*\/|$)|@namespace[^;]+;|@charset[^;]+;/giuy,abEqual=(e,t)=>e===t,St=["urls","urlPrefixes","domains","regexps"];function styleCodeEmpty(e){const{code:t}=e;let n=!t;if(n||null!=(n=e._empty))return n;const r=t.length,a=kt;a.lastIndex=0;let s=0;for(;a.exec(t)&&(s=a.lastIndex)!==r;);return Object.defineProperty(e,"_empty",{value:n=s===r,configurable:!0}),styleCodeEmpty.lastIndex=s,n}function styleSectionsEqual({sections:e},{sections:t}){return e&&t&&e.length===t.length&&e.every(sameSection,t)}function sameSection(e,t){if(equalOrEmpty(e.code,this[t].code,"string",abEqual)){for(const n of St)if(!equalOrEmpty(e[n],this[t][n],"array",arrayMirrors))return;return!0}}function equalOrEmpty(e,t,n,r){const a="array"===n?Array.isArray(e):typeof e===n,s="array"===n?Array.isArray(t):typeof t===n;return a&&s&&r(e,t)||(null==e||a&&!e.length)&&(null==t||s&&!t.length)}function arrayMirrors(e,t){return e.length===t.length&&e.every(thisIncludes,t)&&t.every(thisIncludes,e)}function thisIncludes(e){return this.includes(e)}async function calcStyleDigest(e){const t=e.usercssData?e.sourceCode:JSON.stringify((e.sections||[]).map(e=>({code:e.code||"",urls:e.urls||[],urlPrefixes:e.urlPrefixes||[],domains:e.domains||[],regexps:e.regexps||[]}))),n=(new TextEncoder).encode(t),r=await crypto.subtle.digest("SHA-1",n);return Array.from(new Uint8Array(r),e=>(256+e).toString(16).slice(1)).join("")}const xt=!(!F||!_&&!e.AbortController),It=["chrome://newtab/","chrome://startpage/","chrome://startpageshared/","chrome-extension://mpognobbkildjkofajifpdfhcoklimli/components/startpage/startpage.html","chrome://vivaldi-webui/startpage","about:home","about:newtab"];async function openURL({url:e,index:t,openerTabId:n,active:r=!0,currentWindow:a=!0,newWindow:s,newTab:o}){e.includes("://")||(e=chrome.runtime.getURL(e));let i=!o&&(await browser.tabs.query({url:e.split("#")[0],currentWindow:a}))[0];if(i)return activateTab(i,{index:t,openerTabId:n,url:e!==(i.pendingUrl||i.url)&&e.includes("#")?e:void 0});if(s&&F)return(await F.create(Object.assign({url:e},s))).tabs[0];if(i=await getActiveTab()||{url:""},i&&It.includes((i.pendingUrl||i.url||"").replace("edge://","chrome://"))&&(!i.incognito||!e.startsWith("chrome")))return activateTab(i,{url:e,openerTabId:n});const c=n??i.id,l=null!=c&&!i.incognito&&xt&&{openerTabId:c,windowId:i.windowId};return browser.tabs.create(Object.assign({url:e,index:t,active:r},l))}async function activateTab(e,{url:t,index:n,openerTabId:r}={}){const a={active:!0};return t&&(a.url=t),null!=r&&xt&&(a.openerTabId=r),await Promise.all([browser.tabs.update(e.id,a),F?.update(e.windowId,{focused:!0}),null!=n&&browser.tabs.move(e.id,{index:n})]),e}function getUrlOrigin(e=""){return e.substring(0,e.indexOf("/",e.indexOf(":")+3))}function setUrlParams(e,t){const n=new URL(e);for(const e of["search","searchMode"])e in t?n.searchParams.set(e,t[e]):n.searchParams.delete(e);return n.hash=t.options?"#stylus-options":"",n.href}let Dt;const Tt={exposeIframes:"top",disableAll:"off",styleViaASS:"ass"};function broadcastInjectorConfig(e,t){Dt||(Dt={},safeTimeout(throttle)),Dt[Tt[e]||e]=t}ee.then(()=>{subscribe(Object.keys(Tt),broadcastInjectorConfig),color_scheme_onChange(broadcastInjectorConfig.bind(null,"dark"))});const Et={method:"injectorConfig",cfg:Dt};function setTop(e){return Et.cfg.top=e&&getUrlOrigin(e.url),Et}function throttle(){Et.cfg=Dt,broadcast(Et,{getData:Dt.top&&setTop,onlyIfStyled:!("off"in Dt||"dark"in Dt)}),Dt=null}let Ct;const Ot="usercssTemplate";async function load(){return Ct??=getLZValue(Ot),Ct.then&&(Ct=await Ct),Ct}V.addListener(e=>{(e=e[Ot])&&(Ct=e.newValue)});const Pt=new Map,Mt=["customName","name","url","installationUrl","updateUrl"],extractMeta=e=>e.usercssData?(e.sourceCode.match(h)||[""])[0]:null,stripMeta=e=>e.usercssData?e.sourceCode.replace(h,""):null,Ut=Object.assign(Object.create(null),{code:(e,t)=>e.usercssData?t(stripMeta(e)):searchSections(e,t,"code"),meta:(e,t,n)=>Mt.some(n=>t(e[n]))||t("all"===n?e.sourceCode:extractMeta(e))||searchSections(e,t,"funcs"),name:(e,t)=>t(e.customName)||t(e.name),all:(e,t)=>Ut.meta(e,t,"all")||!e.usercssData&&Ut.code(e,t)});function searchDb({query:e,mode:t,ids:n}){t??="all";let r=[];if("url"===t&&e)r=getByUrl(e).map(e=>e.style.id);else if(t in Ut){const a=Ut[t],s=/^\/(.+?)\/([gimsuy]*)$/.exec(e),o=s&&tryRegExp(s[1],s[2]),i=o?o.test.bind(o):createTester(e);for(const t of iterStyles())n&&!n.includes(t.id)||e&&!a(t,i)||r.push(t.id);Pt.size&&g(clearCache,6e4)}return r}function createTester(e){const t="u"+(lower(e)===e?"i":""),n=e.split(/(".*?")|\s+/).filter(Boolean).map(e=>e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e).filter(e=>e.length>1),r=(n.length?n:[e]).map(e=>stringAsRegExp(e,t));return e=>r.every(t=>t.test(e))}function searchSections({sections:e},t,n){const r="code"===n||"all"===n,a="funcs"===n||"all"===n;for(const n of e)for(const e in n){const s=n[e];if(r&&"code"===e&&t(s)||a&&Array.isArray(s)&&s.some(e=>t(e)))return!0}}function lower(e){let t=Pt.get(e);return t||Pt.set(e,t=e.toLocaleLowerCase()),t}function clearCache(){Pt.clear()}const Rt=new Map,jt=function({size:e=1e3,onDeleted:t}={}){const n=new Map,r=Array(e);let a=0,s=0;return{get(e){const t=n.get(e);return t&&t.data},set(o,i){n.size===e&&(n.delete(r[s].id),t&&t(r[s].id,r[s].data),s=(s+1)%e);const c={id:o,data:i,index:a};n.set(o,c),r[a]=c,a=(a+1)%e},delete(a){const o=n.get(a);if(!o)return!1;n.delete(o.id);const i=r[s];return i.index=o.index,r[o.index]=i,s=(s+1)%e,t&&t(o.id,o.data),!0},clear(){n.clear(),a=s=0},has:e=>n.has(e),*entries(){for(const[e,t]of n)yield[e,t.data]},*values(){for(const e of n.values())yield e.data},get size(){return n.size}}}({onDeleted(e,{sections:t}){for(const n in t){const t=id2data(n);t&&t.appliesTo.delete(e)}}}),$t={test:()=>!1},At=createCompiler(e=>`^(${e})$`),qt=createCompiler(e=>`^${e}$`),Lt=createCompiler(function(e){const t=e.match(/^(\*|[\w-]+):\/\/(\*\.)?([\w.]+\/.*)/);return t?"^"+("*"===t[1]?"[\\w-]+":t[1])+"://"+(t[2]?"(?:[\\w.]+\\.)?":"")+compileGlob(t[3])+"$":"^"+compileGlob(e)+"$"}),Nt=crypto.randomUUID?crypto.randomUUID.bind(crypto):()=>{const e=crypto.getRandomValues(new Uint16Array(8));return e[3]=4095&e[3]|16384,e[4]=16383&e[4]|32768,Array.from(e,hex4dashed).join("")},Bt={cfg:{off:!0}},Wt={name:e=>`ID: ${e.id}`,_id:()=>Nt(),_rev:()=>Date.now()},Ft={livePreview:function({name:e}){const t=id2data(+e.split(":")[1]);t&&(t.preview=null,broadcastStyleUpdated(t.style,"editPreviewEnd"))},draft:function(e){const t=e.name.split(":")[1];u.drafts.delete(+t||t).catch(()=>{})}},Vt="injectionOrder",Ht={main:{},prio:{}},zt={id:Vt,value:mapObj(Ht,()=>[]),_id:`${chrome.runtime.id}-${Vt}`,_rev:0},getOrder=()=>zt.value;te.addCustom(zt,{set:setOrderImpl});class Jt{constructor(e){this.url=e}get urlWithoutHash(){return this._set("urlWithoutHash",this.url.split("#",1)[0])}get urlWithoutParams(){return this._set("urlWithoutParams",this.url.split(/[?#]/,1)[0])}get domain(){return this._set("domain",tryURL(this.url).hostname)}get isOwnPage(){return this._set("isOwnPage",this.url.startsWith(D))}_set(e,t){return Object.defineProperty(this,e,{value:t}),t}}function style_manager_remove(e,t){const{style:n,appliesTo:r}=Rt.get(e),a="sync"!==t,s=n._id;Re.delete(e),a&&u.sync.remove(s,Date.now());for(const t of r){const n=jt.get(t);n&&delete n.sections[e]}return Rt.delete(e),te.delete(s),mapObj(zt.value,(t,n)=>{delete Ht[n][e];const r=t.indexOf(s);r>=0&&t.splice(r,1)}),setOrderImpl(zt,{calc:!1}),n._usw&&n._usw.token&&u.usw.revoke(e),u.drafts.delete(e).catch(()=>{}),broadcast({method:"styleDeleted",style:{id:e}},{onlyIfStyled:!0}),e}function editSave(e){return(e=mergeWithMapped(e)).updateDate=Date.now(),u.drafts.delete(e.id).catch(()=>{}),saveStyle(e,"editSave")}function getEditClientData(e){const t=id2style(e),n=t?"usercssData"in t:G.newStyleAsUsercss;return{style:t,isUC:n,si:t&&u.data.get("editorScrollInfo"+e),template:!t&&n&&(Ct||load())}}function find(e,t){for(const{style:n}of Rt.values()){let r=t?n[t]:n;if(r){for(const t in e)if(e[t]!==r[t]){r=null;break}if(r)return n}}}ee.styles=async function(){const[e,t=[]]=await Promise.all([u.prefsDb.get(zt.id),Re.getAll(),Y]),n=await Promise.all(t.map(fixKnownProblems).filter(Boolean));n.length&&safeTimeout(Re.putMany,0,n),setOrderImpl(e,{store:!1}),t.forEach(storeInMap)}(),chrome.runtime.onConnect.addListener(e=>{const t=e.name.split(":",1)[0],n=Ft[t];n&&e.onDisconnect.addListener(n)}),ee.then(()=>color_scheme_onChange(e=>{broadcastExtension({method:"colorScheme",value:e});for(const{style:e}of Rt.values())Qe.includes(e.preferScheme)&&broadcastStyleUpdated(e,"colorScheme")},!1));const getAll=()=>Array.from(Rt.values(),e=>e.style);function getCodelessStyles(e,t){const n=[];for(const r of e||Rt.values()){const a={...(e?Rt.get(r):r).style};let s;if(t)"usercssData"in a&&(a.usercssData={vars:!isEmptyObj(a.usercssData.vars)&&{foo:1}});else{s=[];for(let e=0,t=a.sections;e<t.length;e++)s[e]={...t[e],code:void 0}}a.sourceCode=void 0,a.sections=s,n.push(a)}return n}function getAllOrdered(e){const t=mapObj(zt.value,e=>e.map(uuid2style).filter(Boolean));if(t.main.length+t.prio.length<Rt.size)for(const{style:e}of Rt.values())e.id in Ht.main||e.id in Ht.prio||t.main.push(e);return e?mapObj(t,t=>t.map(t=>mapObj(t,null,e))):t}function getRemoteInfo(e){if(e)return calcRemoteId(id2style(e));const t={};for(const{style:e}of Rt.values()){const[n,r]=calcRemoteId(e);n&&(t[n]=[e.id,r])}return t}function getSectionsByUrl(e,t,n){const r=G;if(n&&r.disableAll)return Bt;const{sender:a={}}=this||{},{tab:s={},frameId:o,TDM:i}=a,c=!o||i||"main_frame"===a.type,l=!t&&{ass:r.styleViaASS,dark:c&&Ye,name:_&&r.exposeStyleName,nonce:tab_manager_get(s.id,"nonce",o),top:n&&r.exposeIframes&&(c?"":getUrlOrigin(s.url||tab_manager_get(a.tabId||s.id,"url"))),order:Ht};if("cfg"===n)return{cfg:l};0===o&&(e=tab_manager_get(s.id,"url")||e);let d=jt.get(e);d?d.maybeMatch.size&&buildCache(d,e,Array.from(d.maybeMatch,id2data).filter(Boolean)):(d={sections:{},maybeMatch:new Set},buildCache(d,e,Rt.values()),jt.set(e,d));let u=d.sections;return{cfg:l,sections:t?(u=u[t])?[u]:[]:Object.values(u)}}function getByUrl(e,t=null){const n=[],r=t?[id2style(t)].filter(Boolean):iterStyles(),a=new Jt(e);for(const e of r){let t=!0,r=!1,s=!1,o=!1,i=!1,c=!1,l=urlMatchStyle(a,e);"included"===l&&(o=!0),"excluded"===l&&(r=!0),"excludedScheme"===l&&(s=!0);for(const n of e.sections)l=urlMatchSection(a,n,!0),l&&("sloppy"===l&&(i=!0),c=!0,t&&(t=styleCodeEmpty(n)));(c||o)&&n.push({empty:t,excluded:r,excludedScheme:s,included:o,sectionMatched:c,sloppy:i,style:getCodelessStyles([e.id],!0)[0]})}return n}async function importMany(e){const t=[],n=[];for(const r of e)try{beforeSave(r),r.sourceCode&&r.usercssData&&await u.usercss.buildCode(r),t.push(n.push(r)-1)}catch(e){t.push({err:e})}const r=await Re.putMany(n),a=[];for(let e,s=0;s<t.length;s++)if(e=t[s],!e.err){const o=r[e],i=Rt.has(o)?"styleUpdated":"styleAdded",c=handleSave(n[e],!1,o);a.push([c,"import",i]),buildCacheForStyle(c),t[s]={style:c}}return safeTimeout(()=>a.forEach(e=>broadcastStyleUpdated(...e)),100),Promise.all(t)}async function install(e,t=(Rt.has(e.id)?"update":"install")){return(e=mergeWithMapped(e)).originalDigest=await calcStyleDigest(e),saveStyle(e,t)}async function preview(e){let t=e.sourceCode||!1;return t&&(t=await u.usercss.build({styleId:e.id,sourceCode:t,assignVars:!0}),delete t.style.enabled,Object.assign(e,t.style)),id2data(e.id).preview=e,broadcastStyleUpdated(e,"editPreview"),t.log}function setOrder(e){return setOrderImpl({value:e},{broadcast:!0,sync:!0})}async function toggle(e,t){const n=Object.assign({},id2style(e),{enabled:t});await saveStyle(n,"toggle")}async function toggleOverride(e,t,n,r){const a=Object.assign({},id2style(e)),s=n?"inclusions":"exclusions";let o=a[s];if(r){if(o){if(o.includes(t))throw new Error("The rule already exists")}else o=a[s]=[];o.push(t)}else{if(!o)return;{const e=o.indexOf(t);e>=0&&o.splice(e,1)}}jt.clear(),await saveStyle(a,"config")}async function config(e,t,n){const r=Object.assign({},id2style(e)),a=Rt.get(e);r[t]=(a.preview||{})[t]=n,"inclusions"!==t&&"exclusions"!==t||jt.clear(),await saveStyle(r,"config")}function id2data(e){return Rt.get(e)}function id2style(e){return Rt.get(+e)?.style}function uuid2style(e){return id2style(te.get(e))}function calcRemoteId({md5Url:e,updateUrl:t,usercssData:n}={}){let r;return r=(r=/\d+/.test(e)||extractUsoaId(t))&&`uso-${r}`||(r=extractUswId(t))&&`usw-${r}`||"",r&&[r,n&&!isEmptyObj(n.vars)]}function storeInMap(e){Rt.set(e.id,{style:e,appliesTo:new Set}),te.set(e._id,e.id)}function mergeWithMapped(e){return Object.assign({},id2style(e.id)||{enabled:!0,installDate:Date.now()},e)}function buildCacheForStyle(e){const{id:t}=e,n=id2data(t),r=n.preview||e,a=new Set,s=new Set;for(const[e,o]of jt.entries()){if(!n.appliesTo.has(e)){o.maybeMatch.add(t);continue}const i=getAppliedCode(new Jt(e),r);i?(s.add(e),buildCacheEntry(o,r,i)):(a.add(e),delete o.sections[t])}n.appliesTo=s}function broadcastStyleUpdated(e,t,n){return buildCacheForStyle(e),broadcast({method:n?"styleAdded":"styleUpdated",reason:t,style:{id:e.id,enabled:e.enabled}},{onlyIfStyled:!e.enabled})}function beforeSave(e){if(!e.name)throw new Error("Style name is empty");e._id||(e._id=Nt()),e.id||delete e.id,e._rev=Date.now(),fixKnownProblems(e)}async function saveStyle(e,t){return beforeSave(e),handleSave(e,t,await Re.put(e))}function handleSave(e,t,n=e.id){null==e.id&&(e.id=n);const r=id2data(n);return r?r.style=e:storeInMap(e),"sync"!==t&&u.sync.putDoc(e),!1!==t&&broadcastStyleUpdated(e,t,!r),e}function getAppliedCode(e,t){const n=urlMatchStyle(e,t);if("included"===n)return t.sections.map(e=>e.code);if(!0!==n)return;const r=[];for(const n of t.sections)!0!==urlMatchSection(e,n)||styleCodeEmpty(n)||r.push(n.code);return r.length&&r}function fixKnownProblems(e,t,n){e&&e.id||(e={id:Date.now()});let r,a=0;for(const t in Wt)e[t]||(e[t]=Wt[t](e),a=1);for(const t in e)r=e[t],(null==r||"object"==typeof r&&isEmptyObj(r))&&(delete e[t],a=1);const{originalName:s}=e;s&&(s!==e.name&&(e.customName=e.name,e.name=s),delete e.originalName,a=1);for(const t of["url","installationUrl"]){const n=e[t],r=n&&n.replace(/([^:]\/)\//,"$1");r!==n&&(a=1,e[t]=r)}return(r=e.md5Url)&&r.includes("update.update.userstyles")&&(a=e.md5Url=r.replace("update.update.userstyles","update.userstyles")),`${e.url}${e.installationUrl}`.includes("https://33kk.github.io/uso-archive/")&&(delete e.url,delete e.installationUrl),e.url&&e.installationUrl||!(r=e.updateUrl)||!(r=makeInstallUrl(r)||(r=/\d+/.exec(e.md5Url))&&`${P}styles/${r[0]}`)||(e.url||(a=e.url=r),e.installationUrl||(a=e.installationUrl=r)),n&&(!Array.isArray(r=e.sections)&&(r=0,1)||!isEmptyObj(e.usercssData?.vars)&&r.some(hasVarsAndImport))?r||e.sourceCode?u.usercss.buildCode(e):(e.customName="Damaged style #"+(e.id||t),e.sections=[{code:"/* No sections or sourceCode */"}],e):a&&e}function hasVarsAndImport({code:e}){return e.startsWith(":root {\n  --")&&/@import\s/i.test(e)}function urlMatchExclusion(e){return Lt(e).test(this.urlWithoutParams)}function urlMatchStyle(e,t){let n;return(n=t.exclusions)&&n.some(urlMatchExclusion,e)?"excluded":t.enabled?shouldIncludeStyle(t)?!(n=t.inclusions)||!n.some(urlMatchExclusion,e)||"included":"excludedScheme":"disabled"}function urlMatchSection(e,t,n){let r,a,s,o,i,c,l,d;return!!((r=t.domains)&&(a=r.length)&&r.some(urlMatchDomain,e)||(s=t.urlPrefixes)&&(o=s.length)&&s.some(urlMatchPrefix,e)||(l=t.urls)&&(d=l.length)&&(l.includes(e.url)||l.includes(e.urlWithoutHash))||(i=t.regexps)&&(c=i.length)&&i.some(urlMatchRegexp,e))||(c&&i.some(urlMatchRegexpSloppy,e)?"sloppy":!(c||o||d||a||e.isOwnPage||n&&styleCodeEmpty(t)))}function urlMatchDomain(e){const t=this.domain;return e===t||"."===t[t.length-e.length-1]&&t.endsWith(e)}function urlMatchPrefix(e){return e&&this.url.startsWith(e)}function urlMatchRegexp(e){return(!this.isOwnPage||/\bextension\b/.test(e))&&At(e).test(this.url)}function urlMatchRegexpSloppy(e){return(!this.isOwnPage||/\bextension\b/.test(e))&&qt(e).test(this.url)}function createCompiler(e){const t=new Map;return n=>{let r=t.get(n);return r||(r=tryRegExp(e(n)),r||(r=$t),t.set(n,r)),r}}function compileGlob(e){return stringAsRegExpStr(e).replace(/\\\\\\\*|\\\*/g,e=>e.length>2?e:".*")}function buildCache(e,t,n){const r=new Jt(t);for(const a of n){const{style:n}=a,s=n.enabled&&getAppliedCode(r,a.preview||n);s&&(buildCacheEntry(e,n,s),a.appliesTo.add(t))}}function buildCacheEntry(e,t,n=t.code){e.sections[t.id]={code:n,id:t.id,name:t.customName||t.name}}function*iterStyles(){for(const e of Rt.values())yield e.style}function hex4dashed(e,t){return(e+65536).toString(16).slice(-4)+(t>=1&&t<=4?"-":"")}async function setOrderImpl(e,{broadcast:t,calc:n=!0,store:r=!0,sync:a}={}){if(e&&e.value&&!deepEqual(e.value,zt.value)){if(Object.assign(zt,e,a&&{_rev:Date.now()}),n)for(const[t,n]of Object.entries(e.value)){const e=Ht[t]={};n.forEach((t,n)=>{const r=te.get(t);r&&(e[r]=n)})}t&&broadcastInjectorConfig("order",Ht),r&&await u.prefsDb.put(zt,zt.id),a&&u.sync.putDoc(zt)}}const Kt=10,Gt=chrome.declarativeNetRequest,updateDNR=(e,t=e.map(e=>e.id),n)=>Gt[n?"updateSessionRules":"updateDynamicRules"]({addRules:e,removeRuleIds:t}),Qt="patchCsp",Xt="disableAll",Zt="styleViaXhr",Yt=chrome.runtime.id,en="set-cookie",tn="sub_frame",nn=/^('non(e|ce-.+?)'|(https?:\/\/)?[^']+?[^:'])$/,rn=/(?:^|[;,])\s*style-src\s+[^;,]*?'nonce-([-+/=\w]+)'/,an="blob:"+D,sn={url:[{urlPrefix:"http"}]},on={urls:["*://*/*"],types:["main_frame",tn]},makeBlob=e=>new Blob([JSON.stringify(e)],{type:"application/json"}),makeXhrCookie=e=>`${Yt}=${e}; SameSite=Lax`,req2key=e=>e.tabId+":"+e.frameId,revokeObjectURL=t=>t&&e.offscreen.revokeObjectURL(an+t),cn={},INJECTED_FUNC=function(e){1!==this["apply.js"]&&(this[Symbol.for("styles")]=e)},ln=browser.permissions.contains({permissions:["webRequestBlocking"]}),dn={};let un=!1,pn=!1,fn=!1;function style_via_webrequest_toggle(e){const t=!e,n=G[Xt],r=!n&&G[Qt],a=!n&&G[Zt];if(!t&&a===fn&&r===pn&&n===un)return;let s;(k||r!==pn)&&(s=chrome.webRequest.onHeadersReceived,toggleListener(s,!1,modifyHeaders),toggleListener(s,!0,modifyHeaders,on,["blocking","responseHeaders",!1].filter(Boolean))),(t||n!==un)&&toggleListener(chrome.webRequest.onBeforeRequest,t||!n,prepareStyles,on),(t||_&&(s=!n&&!a)!=(!un&&!fn))&&toggleListener(tt.onCommitted,s,injectData,sn),pn=r,un=n,fn=a}async function prepareStyles(e){ee.resolve&&await ee;const{url:t}=e,n=req2key(e),r=cn[n],a=r||(cn[n]={}),s={sender:(e.tab={url:t},e)},o=a.payload=getSectionsByUrl.call(s,t,null,!0),i=o.sections.length;a.url=t,r&&removePreloadedStyles(null,n,a,i),fn&&i&&prepareStylesMV3(e,a,0,o)}async function prepareStylesMV3({tabId:t,frameId:n,url:r},a,s,o){let i;for(const e in cn){const n=cn[e];if(n.url===r&&deepEqual(o,n.payload)){setTimeout(removeTemporaryTab,1e4,t),o=n.payload,i=n.blobId;break}}i||(i=(await e.offscreen.createObjectURL(makeBlob(o))).slice(an.length)),a.blobId=i;const c=makeXhrCookie(i);let{ruleId:l=0}=a;if(!l){for(;++l in dn;);a.ruleId=l}state_db_set(-l,dn[l]={t,f:n,b:i}),updateDNR([{id:l,condition:{tabIds:[t],resourceTypes:[n?tn:"main_frame"],excludedResponseHeaders:[{header:en,values:[c]}]},action:{type:"modifyHeaders",responseHeaders:[{header:en,value:c,operation:"append"}]}}],[l],!0)}function injectData(e){const t=cn[req2key(e)];t&&!t.injected&&(t.injected=!0,chrome.scripting.executeScript({target:{tabId:e.tabId,frameIds:[e.frameId]},args:[t.payload],func:INJECTED_FUNC,injectImmediately:!0},ignoreChromeError),fn||removePreloadedStyles(e))}function modifyHeaders(e){const t=req2key(e),n=cn[t];if(!n)return;const{responseHeaders:r}=e,{payload:a}=n,s=a.sections,o=(k||pn)&&findHeader(r,"content-security-policy");if(o){const t=o.value.match(rn);t&&tab_manager_set(e.tabId,"nonce",e.frameId,a.cfg.nonce=t[1]),pn&&s[0]&&patchCsp(o)}if(!s[0])return void removePreloadedStyles(e,t,n);let i;return fn&&(i=n.blobId??=!1)&&(i=makeXhrCookie(i),findHeader(r,en,i)?i=!1:r.push({name:en,value:i})),i||o&&pn?{responseHeaders:r}:void 0}function patchCsp(e){const t={};for(let n of e.value.split(/[;,]/))n=n.trim().split(/\s+/),t[n[0]]=n.slice(1);patchCspSrc(t,"img-src","data:","*"),patchCspSrc(t,"font-src","data:","*"),patchCspSrc(t,"style-src","'unsafe-inline'","*"),t.sandbox&&!t.sandbox.includes("allow-same-origin")&&t.sandbox.push("allow-same-origin"),e.value=Object.entries(t).map(([e,t])=>`${e}${t.length?" ":""}${t.join(" ")}`).join("; ")}function patchCspSrc(e,t,...n){let r=e["default-src"],a=e[t];(r||a)&&(r||(r=[]),a||(a=[...r]),n.includes("*")&&(a=e[t]=a.filter(e=>!nn.test(e))),a.push(...n.filter(e=>!a.includes(e))),a.length||delete e[t])}function removePreloadedStyles(e,t=req2key(e),n=cn[t],r){if(!n)return;r||delete cn[t];let a=n.blobId;a&&(e?safeTimeout(revokeObjectURL,1e4,a):revokeObjectURL(a),n.blobId=""),(a=n.timer)&&(n.timer=clearTimeout(a)),!r&&(a=n.ruleId)in dn&&(delete dn[a],updateDNR(void 0,[a],!0),remove(-a))}async function removeTemporaryTab(e){try{await chrome.tabs.get(e)}catch{tab_manager_remove(e),e+=":";for(const t in cn)t.startsWith(e)&&removePreloadedStyles(null,t)}}function findHeader(e,t,n){for(const r of e)if(r.name.toLowerCase()===t&&(null==n||r.value===n))return r}style_via_webrequest_toggle(),e.offscreen.syncLifetimeToSW(!0),Ae?.then(([e,,t])=>{const n=[];e.forEach((e,r)=>{if(r<0){r=-r;const{t:a,f:s,b:o}=e,i=t[a];i?(dn[r]=e,cn[a+":"+s]={ruleId:r,blobId:o,url:i.url}):(revokeObjectURL(o),n.push(r),remove(-r))}}),n.length&&updateDNR(void 0,n,!0)}),Y.then(()=>{style_via_webrequest_toggle(!0),subscribe([Xt,Qt,Zt],style_via_webrequest_toggle)}),ot.add((e,t)=>{removePreloadedStyles(null,e+":"+t)}),tt.onErrorOccurred.addListener(removePreloadedStyles,sn),_&&chrome.webRequest.onBeforeRequest.addListener(e=>{u.data.set("popup",e.tabId<0&&makePopupData())},{urls:[T],types:["main_frame"]});const hn=k||!I?[16,32]:[19,38],gn=new Set,mn={},yn={color:"",text:""};let wn=!(k&&S)&&null;function updateIconBadge(e,{lazyBadge:t,iid:n}={}){const{tab:{id:r},TDM:a}=this.sender,s=a>0?0:this.sender.frameId,o=e.length?e.map(Number):void 0;tab_manager_set(r,"styleIds",s,o),n&&tab_manager_set(r,"iid",s,n),g(refreshStaleBadges,s&&t?250:0),gn.add(r),s||refreshIcon(r,!0),removePreloadedStyles(null,r+":"+s)}function overrideBadge({text:e="",color:t="",title:n=""}={}){if(yn.text!==e){yn.text=e,yn.color=t,refreshIconBadgeColor(),setBadgeText({text:e});for(const t of ct())e?setBadgeText({tabId:t,text:e}):refreshIconBadgeText(t);safeCall("setTitle",{title:n&&chrome.i18n.getMessage(n)||n||""})}}function refreshIconBadgeText(e){yn.text||setBadgeText({tabId:e,text:Z("show-badge")?`${getStyleCount(e)}`:""})}function getIconName(e=!1){const t=Z("iconset");return`${0===t||-1===t&&Ye?"":"light/"}$SIZE$${Z("disableAll")?"x":e?"":"w"}`}function refreshIcon(e,t=!1){const n=tab_manager_get(e,"icon"),r=getIconName(getStyleIds(e)[0]);(t||n!==r)&&(tab_manager_set(e,"icon",r),setIcon({path:getIconPath(r),tabId:e}))}function getIconPath(e){return hn.reduce((t,n)=>(t[n]=B+e.replace("$SIZE$",n)+W,t),{})}function getStyleCount(e){const t=new Set,n=getStyleIds(e)||{};return Object.values(n).forEach(e=>e.forEach(e=>t.add(e))),t.size||""}async function loadImage(e){const{OffscreenCanvas:t}=_&&self.createImageBitmap&&self||{},n=t?await createImageBitmap(await(await fetch(e)).blob()):await new Promise((t,n)=>Object.assign(new Image,{src:e,onload:e=>t(e.target),onerror:n})),{width:r,height:a}=n,s=(t?new t(r,a):Object.assign(document.createElement("canvas"),{width:r,height:a})).getContext("2d");s.drawImage(n,0,0,r,a);const o=s.getImageData(0,0,r,a);return mn[e]=o,o}function refreshGlobalIcon(){setIcon({path:getIconPath(getIconName())})}function refreshIconBadgeColor(){setBadgeBackgroundColor({color:yn.color||Z(Z("disableAll")?"badgeDisabled":"badgeNormal")})}function refreshAllIcons(){for(const e of ct())refreshIcon(e);refreshGlobalIcon()}function refreshAllIconsBadgeText(){for(const e of ct())refreshIconBadgeText(e)}function refreshStaleBadges(){for(const e of gn)refreshIconBadgeText(e);gn.clear()}function safeCall(e,t){const{action:n={},browserAction:r=n}=chrome,a=r[e];if(a)try{a.call(r,t,ignoreChromeError)}catch{a.call(r,t)}}async function setIcon(e){if(null==wn){const e=B+hn[0]+W;wn=mn[e]=loadImage(e),wn=(await wn).data.some(e=>255!==e)}else wn.then&&await wn;if(wn){e.imageData={};for(const[t,n]of Object.entries(e.path)){const r=mn[n]||(mn[n]=loadImage(n));e.imageData[t]=r.then?await r:r}delete e.path}safeCall("setIcon",e)}function setBadgeText(e){safeCall("setBadgeText",e)}function setBadgeBackgroundColor(e){safeCall("setBadgeBackgroundColor",e)}color_scheme_onChange(()=>{-1===Z("iconset")&&g(refreshGlobalIcon)},!1),ee.then(()=>{subscribe(["disableAll","badgeDisabled","badgeNormal"],()=>g(refreshIconBadgeColor),!0),subscribe(["show-badge"],()=>g(refreshAllIconsBadgeText),!0),subscribe(["disableAll","iconset"],()=>g(refreshAllIcons),!0)}),ot.add((e,t,n)=>{t&&getStyleIds(e)&&updateIconBadge.call(n,[],{lazyBadge:!0})});const bn="connected",vn="connecting",_n="disconnected",kn="disconnecting",Sn="pending",xn={dropbox:{flow:"token",clientId:"zg52vphuapvpng9",authURL:"https://www.dropbox.com/oauth2/authorize",tokenURL:"https://api.dropboxapi.com/oauth2/token",revoke:e=>fetch("https://api.dropboxapi.com/2/auth/token/revoke",{method:"POST",headers:{Authorization:`Bearer ${e}`}})},google:{flow:"code",clientId:"283762574871-d4u58s4arra5jdan2gr00heasjlttt1e.apps.googleusercontent.com",clientSecret:"J0nc5TlR_0V_ex9-sZk-5faf",authURL:"https://accounts.google.com/o/oauth2/v2/auth",authQuery:{access_type:"offline",prompt:"consent"},tokenURL:"https://oauth2.googleapis.com/token",scopes:["https://www.googleapis.com/auth/drive.appdata"]},onedrive:{flow:"code",clientId:"3864ce03-867c-4ad8-9856-371a097d47b1",clientSecret:"9Pj=TpsrStq8K@1BiwB9PIWLppM:@s=w",authURL:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenURL:"https://login.microsoftonline.com/common/oauth2/v2.0/token",scopes:["Files.ReadWrite.AppFolder","offline_access"]},userstylesworld:{flow:"code",clientId:"zeDmKhJIfJqULtcrGMsWaxRtWHEimKgS",clientSecret:"wqHsvTuThQmXmDiVvOpZxPwSIbyycNFImpAOTxjaIRqDbsXcTOqrymMJKsOMuibFaijZZAkVYTDbLkQuYFKqgpMsMlFlgwQOYHvHFbgxQHDTwwdOroYhOwFuekCwXUlk",authURL:j+"api/oauth/style/link",tokenURL:j+"api/oauth/token",redirect_uri:"https://gusted.xyz/callback_helper/"}},In=30,Dn="https://clngdbkpkpeebahjckkjfobafhncgmne.chromiumapp.org/";class Tn extends Error{constructor(e,t){super(`[${e}] ${t}`),this.name="TokenError",this.provider=e,Error.captureStackTrace&&Error.captureStackTrace(this,Tn)}}function buildKeys(e,t){const n=`secure/token/${t?t.keyName(e):e}/`,r={TOKEN:`${n}token`,EXPIRE:`${n}expire`,REFRESH:`${n}refresh`};return r.LIST=Object.values(r),r}async function getToken(e,t,n){const r=buildKeys(e,n),a=await Ee.get(r.LIST);if(a[r.TOKEN]){if(!a[r.EXPIRE]||Date.now()<a[r.EXPIRE])return a[r.TOKEN];if(a[r.REFRESH])return refreshToken(e,r,a)}if(!t)throw new Tn(e,"Token is missing");return authUser(r,e,t,n)}async function revokeToken(e,t){const n=xn[e],r=buildKeys(e,t);if(n.revoke)try{const e=await Ee.getValue(r.TOKEN);e&&await n.revoke(e)}catch(e){console.error(e)}await Ee.remove(r.LIST)}async function refreshToken(e,t,n){if(!n[t.REFRESH])throw new Tn(e,"No refresh token");const r=xn[e],a={client_id:r.clientId,refresh_token:n[t.REFRESH],grant_type:"refresh_token",scope:r.scopes.join(" ")};r.clientSecret&&(a.client_secret=r.clientSecret);const s=await postQuery(r.tokenURL,a);return s.refresh_token||(s.refresh_token=n[t.REFRESH]),handleTokenResult(s,t)}async function authUser(e,t,n=!1,r=null){const a=xn[t],s=Math.random().toFixed(8).slice(2),o=a.redirect_uri,i={response_type:a.flow,client_id:a.clientId,redirect_uri:o||Dn,state:s};a.scopes&&(i.scope=a.scopes.join(" ")),a.authQuery&&Object.assign(i,a.authQuery),r?.query(i);const c=`${a.authURL}?${new URLSearchParams(i)}`,l=await authUserMV3(c,n,o),d=new URLSearchParams("token"===a.flow?new URL(l).hash.slice(1):new URL(l).search.slice(1));if(d.get("state")!==s)throw new Tn(t,`Unexpected state: ${d.get("state")}, expected: ${s}`);let u;if("token"===a.flow){const e={};for(const[t,n]of d)e[t]=n;u=e}else{const e={code:d.get("code"),grant_type:"authorization_code",client_id:a.clientId,redirect_uri:i.redirect_uri,state:s};a.clientSecret&&(e.client_secret=a.clientSecret),u=await postQuery(a.tokenURL,e)}return handleTokenResult(u,e)}async function authUserMV3(e,t,n){n&&await updateDNR([{id:Kt,condition:{urlFilter:"|"+n,resourceTypes:["main_frame"]},action:{type:"redirect",redirect:{transform:{host:Dn.split("/")[2]}}}}]);try{return await chrome.identity.launchWebAuthFlow({interactive:t,url:e})}finally{n&&await updateDNR(null,[Kt])}}async function handleTokenResult(e,t){return await Ee.set({[t.TOKEN]:e.access_token,[t.EXPIRE]:e.expires_in?Date.now()+1e3*(e.expires_in-In):void 0,[t.REFRESH]:e.refresh_token}),e.access_token}async function postQuery(e,t){const n={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:t?new URLSearchParams(t):null},r=await fetch(e,n);if(r.ok)return r.json();const a=await r.text(),s=new Error(`Failed to fetch (${r.status}): ${a}`);throw s.code=r.status,s}const En="syncNow",Cn="sync.enabled",On=10/60,Pn=1,Mn=30,Un="sync/state/",Rn=["webdav"],jn={STATES:r,state:Sn,syncing:!1,progress:null,currentDriveName:null,errorMessage:null,login:!1},compareRevision=(e,t)=>e-t;let $n,An,qn,Ln,Nn,Bn,Wn,Fn=null;async function sync_manager_remove(...e){if(Ln&&await start(),An)return schedule(),$n.delete(...e)}function getStatus(){return Ln&&start(),jn}async function login(e){Ln&&await start(),e||(e=qn),await revokeToken(e);try{await getToken(e,!0),jn.login=!0}catch(e){throw jn.login=!1,e}finally{emitStatusChange()}}async function putDoc({_id:e,_rev:t}){if(Ln&&await start(),An)return schedule(),$n.put(e,t)}async function setDriveOptions(e,t){const n=`secure/sync/driveOptions/${e}`;await setValue(n,t)}async function getDriveOptions(e){const t=`secure/sync/driveOptions/${e}`;return await getValue(t)||{}}async function start(e=Ln){const t=e&&e===Ln,n=jn.state===kn;if(Ln=!1,($n??=dbToCloud({onGet:e=>uuid2style(e)||te.custom[e],async onPut(e){if(!e)return;const t=te.get(e._id),n=!t&&te.custom[e._id],r=n||id2style(t),a=r?compareRevision(r._rev,e._rev):-1;a&&(a>0?putDoc(r):n?te.custom[e._id]=e:(delete e.id,t&&(e.id=t),e.id=await Re.put(e),await handleSave(e,"sync")))},onDelete(e,t){const n=te.get(e),r=id2style(n);return r&&compareRevision(r._rev,t)<=0&&style_manager_remove(n,"sync")},onFirstSync(){for(const e of Object.values(te.custom).concat(getAll()))$n.put(e._id,e._rev)},onProgress(e){"start"===e.phase?jn.syncing=!0:"end"===e.phase?(jn.syncing=!1,jn.progress=null):jn.progress=e,Fn&&setError(),emitStatusChange()},compareRevision,getState:e=>Ee.getValue(Un+e.name),setState:(e,t)=>Ee.setValue(Un+e.name,t),retryMaxAttempts:10,retryExp:1.2,retryDelay:6})).then&&($n=await $n),!An){if(qn=e,An=getDrive(e),An=await An,$n.use(An),jn.state=vn,jn.currentDriveName=qn,emitStatusChange(),t||Rn.includes(qn))jn.login=!0;else try{await login(e)}catch(e){return console.error(e),setError(e),emitStatusChange(),stop()}await $n.init(),n||(await syncNow(),set(Cn,e),jn.state=bn,emitStatusChange())}}async function stop(){if(Ln){jn.state=kn;try{await start()}catch{}}if(An){jn.state=kn,emitStatusChange();try{await $n.uninit(),await revokeToken(qn),await Ee.remove(Un+qn)}catch{}An=qn=null,set(Cn,"none"),jn.state=_n,jn.currentDriveName=null,jn.login=!1,emitStatusChange()}}async function syncNow(){if(!Wn)if(Wn=!0,Ln&&await start(),An&&jn.login){try{await $n.syncNow(),setError()}catch(e){e.message=translateErrorMessage(e),setError(e),isGrantError(e)&&(jn.login=!1)}Nn&&(Nn(),Nn=null),Wn=!1,emitStatusChange()}else console.warn("cannot sync when disconnected")}function emitStatusChange(){broadcastExtension({method:"syncStatusUpdate",status:jn}),overrideBadge(getErrorBadge())}function isGrantError(e){return 401===e.code||!(400!==e.code||!/invalid_grant/.test(e.message))||"TokenError"===e.name}function getErrorBadge(){if(jn.state===bn&&(!jn.login||Fn&&!("TypeError"===(e=Fn).name&&/networkerror|failed to fetch/i.test(e.message)||502===e.code)))return{text:"x",color:"#F00",title:jn.login?`${chrome.i18n.getMessage("syncError")}\n---------------------\n${Fn.message.replace(/.{60,}?\s(?=.{30,})/g,"$&\n")}`:"syncErrorRelogin"};var e}async function getDrive(e){if(!f(Se,e))throw new Error(`Unknown cloud provider: ${e}`);const t=await getDriveOptions(e);return"webdav"===e||(t.getAccessToken=()=>getToken(e)),Se[e](t)}async function schedule(t,n=qn){if(Bn)return;Bn=!0;const r=t&&await browser.alarms.get(En);Ln=f(Se,n)&&n,Ln?(!r||Math.abs((r.periodInMinutes||1e99)-Mn)>1e-6||((r.scheduledTime-Date.now())/6e4+Mn)%Mn>(t?Mn:Pn))&&(chrome.alarms.create(En,{delayInMinutes:t?On:Pn,periodInMinutes:Mn}),Nn||e.keepAlive(new Promise(e=>Nn=e))):(jn.state=_n,r&&chrome.alarms.clear(En),t&&emitStatusChange()),Bn=!1}function setError(e){jn.errorMessage=e?.message,Fn=e}function translateErrorMessage(e){return"LockError"===e.name?browser.i18n.getMessage("syncErrorLock",new Date(e.expire).toLocaleString([],{timeStyle:"short"})):e.message||JSON.stringify(e)}chrome.alarms.onAlarm.addListener(t=>{t.name===En&&e.keepAlive(syncNow())}),subscribe(Cn,schedule,!0);const Vn={headers:{"cache-control":"no-cache"}},Hn=`${function(e){Object.assign(this.clientData,e)}}`;async function setClientData(e,{dark:t=!!+e.get("dark"),url:n=e.get("url")}={}){let r,a;ee.resolve&&await ee;const s=new URL(n),o=s.pathname.slice(1,-5),i={};return Xe(t),Object.assign(i,{apply:getSectionsByUrl(n,null,!0),dark:Ye,favicon:k||re,prefs:vt.get()},"edit"===o?getEditClientData(+s.searchParams.get("id")):"manage"===o?{badFavs:G["manage.newUI"]&&G["manage.newUI.favicons"]&&u.prefsDb.get("badFavs"),ids:(r=(a=s.searchParams).get("search")||void 0)&&searchDb({query:r,mode:a.get("searchMode")||G["manage.searchMode"]}),styles:getCodelessStyles()}:"options"===o?{sync:r=getStatus(),syncOpts:(r=r.currentDriveName)?getDriveOptions(r):{},wrb:ln}:"popup"===o?{popup:u.data.pop("popup")||makePopupData()}:null),r=await Promise.all(Object.values(i)),Object.keys(i).forEach((e,t)=>i[e]=r[t]),new Response(`(${Hn})(${JSON.stringify(i)})`,Vn)}const zn="resolve";function reinjectContentScripts(){const e="<all_urls>",t=L.content_scripts,globToRe=(e,t=".")=>stringAsRegExpStr(e.replace(/\*/g,"\n")).replace(/\n/g,t+"*?");for(const n of t)(n[e]=n.matches.includes(e))||n.matches.forEach((e,t)=>{const[,r,a,s]=e.match(/^([^:]+):\/\/([^/]+)\/(.*)/);n.matches[t]=new RegExp(`^${"*"===r?"https?":r}://${globToRe(a,"[^/]")}/${globToRe(s)}$`)});const n=new Set;let r;async function injectToTab(n,r){const a=[];if(tab_manager_set(n,"url",r),!await sendTab(n,{method:"backgroundReady"})){for(const s of t)(s[e]||s.matches.some(r.match,r))&&a.push(chrome.scripting.executeScript({injectImmediately:"document_start"===s.run_at,target:{allFrames:s.all_frames,tabId:n},files:s.js}).catch(ignoreChromeError));await Promise.all(a)}}function toggleBusyTabListeners(e){const t=e?"addListener":"removeListener";tt.onCompleted[t](onBusyTabUpdated),tt.onErrorOccurred[t](onBusyTabUpdated),tt.onTabReplaced[t](onBusyTabReplaced),chrome.tabs.onRemoved[t](onBusyTabRemoved),e?r=safeTimeout(toggleBusyTabListeners,15e3,!1):clearTimeout(r)}function trackBusyTab(e,t){n[t?"add":"delete"](e),t&&1===n.size&&toggleBusyTabListeners(!0),t||n.size||toggleBusyTabListeners(!1)}function onBusyTabUpdated({error:e,frameId:t,tabId:r,url:a}){!t&&n.has(r)&&(trackBusyTab(r,!1),a&&!e&&A(a)&&injectToTab(r,a))}function onBusyTabReplaced({replacedTabId:e}){trackBusyTab(e,!1)}function onBusyTabRemoved(e){trackBusyTab(e,!1)}safeTimeout(async function(){for(const e of await browser.tabs.query({})){const t=e.pendingUrl||e.url;e.width&&!e.discarded&&A(t)&&("loading"===e.status?trackBusyTab(e.id,!0):await injectToTab(e.id,t))}})}const Jn="disableAll",Kn="styleManager",Gn="openOptions",Qn="reload",context_menus_openManage=()=>u.openManage(),openOptions=()=>u.openManage({options:!0}),reload=()=>chrome.runtime.reload(),styleDisableAll=e=>set(Jn,e?e.checked:!Z(Jn)),Xn={openManage:context_menus_openManage,[Gn]:openOptions,[Qn]:reload,styleDisableAll},Zn=Object.assign({"show-badge":[function(e){set(e.menuItemId,e.checked)},{title:"menuShowBadge"}],[Jn]:[styleDisableAll,{title:"disableAllStyles"}],[Kn]:[context_menus_openManage],[Gn]:[openOptions],[Qn]:[reload]},_&&{"editor.contextDelete":[(e,t)=>{sendTab(t.id,{method:"editDeleteText"},void 0,"extension")},{title:"editDeleteText",type:"normal",contexts:["editable"],documentUrlPatterns:[D+"*"]}]});function initContextMenus(){function createContextMenus(e,t){for(const n of e){const e=Zn[n][1]??={};if(t&&(e.id=n,e.contexts??=["action"],e.title=chrome.i18n.getMessage(e.title??n)),"boolean"==typeof J[n])if(e.type){if(t){subscribe(n,togglePresence,!0);continue}}else e.type="checkbox",e.checked=G[n],t&&subscribe(n,toggleCheckmark);chrome.contextMenus.create(e,ignoreChromeError)}}function toggleCheckmark(e,t){chrome.contextMenus.update(e,{checked:t},ignoreChromeError)}function togglePresence(e,t){t?createContextMenus([e]):chrome.contextMenus.remove(e,ignoreChromeError)}createContextMenus(Object.keys(Zn),!0)}chrome.commands?.onCommand.addListener(e=>Xn[e]()),chrome.contextMenus.onClicked.addListener((e,t)=>Zn[e.menuItemId][0](e,t));const Yn={},callAbort=(e,t)=>e.abort("Timeout fetching "+t);function download(e,t={}){const n=arguments[1]?e+"\0"+JSON.stringify(t):e,r=Yn[n]||(Yn[n]={req:doDownload(e,t,n)});if(t.port){const e=r.ports||(r.ports=new Set),n=chrome.runtime.connect({name:t.port});n.onDisconnect.addListener(()=>e.delete(n)),e.add(n)}return r.req}async function doDownload(e,{method:t="GET",body:n,responseType:r="text",requiredStatusCode:a=200,timeout:s=6e4,loadTimeout:o=12e4,headers:i,responseHeaders:c,port:l},d){let u,p,f,h;try{if(e.startsWith(P)&&e.includes("?")){const r=e.indexOf("?");null==n?(t="POST",n=e.slice(r),e=e.slice(0,r)):"GET"===t&&e.length>=2e3&&e.startsWith(U)&&(e=collapseUsoVars(h=[],e,r)),i??={"content-type":"application/x-www-form-urlencoded"}}const g=await fetch(e,{body:n,method:t,signal:s?(u=new AbortController,f=safeTimeout(callAbort,s,u,e),u.signal):null});if(f&&clearTimeout(f),f=o&&safeTimeout(callAbort,o,u,e),a&&g.status!==a&&!e.startsWith("file:"))throw new Error(`Bad status code ${g.status} for ${e}`);return p=l?await fetchWithProgress(g,r,i,d):await g["arraybuffer"===r?"arrayBuffer":r](),p&&h&&(p=expandUsoVars(h,e,p)),c&&(p={response:p,headers:extractHeaders(g,c)}),p}finally{f&&clearTimeout(f),Yn[d].ports?.forEach(e=>e.disconnect()),delete Yn[d]}}function collapseUsoVars(e,t,n){const r=new URLSearchParams(t.slice(n+1));for(const[t,n]of r.entries())n.length<10||n.startsWith("ik-")||(e.push(n),r.set(t,`${e.length}`));return t.slice(0,n+1)+r}function expandUsoVars(e,t,n){const r="string"==typeof n,a=r&&util_tryJSONparse(n)||n;a.updateUrl=t;for(const t of a.sections||[]){const{code:n}=t;n.includes("")&&(t.code=n.replace(/\x01(\d+)\x02/g,(t,n)=>e[n-1]||""))}return r?JSON.stringify(a):a}function extractHeaders(e,t){const n={};for(const r of t)n[r]=e.headers.get(r);return n}async function fetchWithProgress(e,t,n,r){const a=[];let s,o=0;for await(const t of e.body)a.push(t),o+=t.length,reportProgress(r,[o]);if(1===a.length)s=a[0];else{s=new Uint8Array(o),o=0;for(const e of a)s.set(e,o),o+=e.length}return"blob"===t?s=new Blob([s],{type:n.get("content-type")}):"arraybuffer"===t?s=s.buffer:(s=(new TextDecoder).decode(s),"json"===t&&(s=JSON.parse(s))),s}function reportProgress(e,t){Yn[e].ports?.forEach(e=>e.postMessage(t))}const er=/^(.*?)-([-.0-9a-z]+)|$/i,tr=/^\d+$/;function compareVersion(e,t){const[,n=e||"",r]=er.exec(e),[,a=t||"",s]=er.exec(t),o=compareVersionChunk(n,a)||!r-!s||r&&compareVersionChunk(r,s,!0);return Math.sign(o)}function compareVersionChunk(e,t,n){const r=e.split("."),a=t.split("."),s=r.length,o=a.length,i=(n?Math.min:Math.max)(s,o);let c;for(let e=0;!c&&e<i;e+=1){const t=r[e],s=a[e];c=n?tr.test(t)&&tr.test(s)?t-s:t>s||t<s&&-1:(parseInt(t,10)||0)-(parseInt(s,10)||0)}return c||n&&s-o}const nr={UPDATED:"updated",SKIPPED:"skipped",UNREACHABLE:"server unreachable",EDITED:"locally edited",MAYBE_EDITED:"may be locally edited",SAME_MD5:"up-to-date: MD5 is unchanged",SAME_CODE:"up-to-date: code sections are unchanged",SAME_VERSION:"up-to-date: version is unchanged",ERROR_MD5:"error: MD5 is invalid",ERROR_JSON:"error: JSON is invalid",ERROR_VERSION:"error: version is older than installed style"},getStates=()=>nr,rr={responseHeaders:["etag"]},ar=new RegExp([/^(\d{4})/,/(0[1-9]|1(?:0|[12](?=\d\d))?|[2-9])/,/(0[1-9]|[1-2][0-9]?|3[0-1]?|[4-9])/,/\.([01][0-9]?|2[0-3]?|[3-9])/,/\.([0-5][0-9]?|[6-9])$/].map(e=>e.source).join("")),sr="scheduledUpdate",or=6e4,ir=[503,429];let cr,lr=!1,dr=[],ur=0;async function checkAllStyles({save:e=!0,ignoreDigest:t,observe:n,onlyEnabled:r=Z("updateOnlyEnabled")}={}){Ee.setValue("lastUpdateTime",cr=Date.now()),update_manager_schedule(),lr=!0;const a=n&&chrome.runtime.connect({name:"updater"}),s=getAll().filter(e=>e.updateUrl&&!1!==e.updatable&&(!r||e.enabled));a&&a.postMessage({count:s.length}),log(""),log(`${e?"Scheduled":"Manual"} update check for ${s.length} styles`),await Promise.all(s.map(n=>checkStyle({style:n,port:a,save:e,ignoreDigest:t}))),a&&a.postMessage({done:!0}),a&&a.disconnect(),log(""),lr=!1}async function checkStyle(e){let{id:t}=e;const{style:n=id2style(t),ignoreDigest:r,port:a,save:s}=e;t||(t=n.id);const{md5Url:o}=n;let i,c,{usercssData:l,updateUrl:d}=n;try{await async function(){if(!r&&n.originalDigest&&n.originalDigest!==await calcStyleDigest(n))return Promise.reject(nr.EDITED)}(),i={style:await(l&&!o?updateUsercss:async function(){const e=await tryDownload(o);if(!e||32!==e.length)return Promise.reject(nr.ERROR_MD5);if(e===n.originalMd5&&n.originalDigest&&!r)return Promise.reject(nr.SAME_MD5);const t=+o.match(/\/(\d+)/)[1];let a="";l||(l={},a=d),d=n.updateUrl=`${M}Css/${t}`;const{result:s}=await tryDownload(d,{responseType:"json"}),i=await updateUsercss(s)||await u.uso.toUsercss(t,a,s,n,e,o);return i.originalMd5=e,i})().then(async function(e){e.id=t,delete e.customName,delete e.enabled;const a=Object.assign({},n,e);return a.updateDate=getDateFromVer(a)||Date.now(),!l&&styleSectionsEqual(e,n)?(n.originalDigest=(await install(a)).originalDigest,Promise.reject(nr.SAME_CODE)):n.originalDigest||r?s?l?u.usercss.install(a,{dup:n}):install(a):a:Promise.reject(nr.MAYBE_EDITED)}),updated:!0},c=nr.UPDATED}catch(e){const t=0===e&&nr.UNREACHABLE||e&&e.message||e;i={error:t,style:n,STATES:nr},c=`${nr.SKIPPED} (${Array.isArray(e)?e[0].message:t})`}return log(`${c} #${t} ${n.customName||n.name}`),a&&a.postMessage(i),i;async function updateUsercss(e){let t=l.version,a=n.etag;const s=(e||extractUsoaId(d))&&await u.uso.getEmbeddedMeta(e||n.sourceCode);if(s&&s.updateUrl)d=s.updateUrl,t=s.usercssData.version||"0",a="";else if(e)return;if(a&&a===await downloadEtag(d))return Promise.reject(nr.SAME_CODE);const{headers:{etag:o},response:i}=await tryDownload(d,rr),c=await u.usercss.buildMeta({sourceCode:i,etag:o,updateUrl:d}),p=compareVersion(c.usercssData.version,t);let f;return p||r||(f=i===n.sourceCode?nr.SAME_CODE:!q(d)&&nr.SAME_VERSION),p<0&&(f=nr.ERROR_VERSION),f&&o&&!n.etag&&(n.etag=o,await Re.put(n)),f?Promise.reject(f):c}}async function tryDownload(e,t,{retryDelay:n=1e3}={}){for(;;){try{return t=deepMerge(t||{},{headers:{"Cache-Control":"no-cache"}}),await download(e,t)}catch(e){if(!ir.includes(e)||n>or)return Promise.reject(e)}n*=1.25,await new Promise(e=>safeTimeout(e,n))}}async function downloadEtag(e){return(await tryDownload(e,{method:"HEAD",...rr})).headers.etag}function getDateFromVer(e){const t=ar.exec(e.usercssData?.version);if(t)return t[2]--,new Date(...t.slice(1)).getTime()}function update_manager_schedule(){const e=60*Z("updateInterval")*60*1e3;if(e>0){const t=Math.max(0,Date.now()-cr);chrome.alarms.create(sr,{when:Date.now()+Math.max(or,e-t)})}else chrome.alarms.clear(sr,ignoreChromeError)}function update_manager_onAlarm({name:t}){t===sr&&e.keepAlive(checkAllStyles())}function log(e){dr.push({text:e,time:(new Date).toLocaleString()}),g(flushQueue,e&&lr?1e3:0)}async function flushQueue(e){if(!e)return void flushQueue(await Ee.getValue("updateLog")||[]);const t=Date.now()-ur>11e3?dr[0].time+" ":"";dr[0]&&!dr[0].text&&(dr.shift(),e[e.length-1]&&e.push("")),e.splice(0,e.length-1e3),e.push(t+(dr[0]&&dr[0].text||"")),e.push(...dr.slice(1).map(e=>e.text)),Ee.setValue("updateLog",e),ur=Date.now(),dr=[]}ee.then(async()=>{cr=await Ee.getValue("lastUpdateTime")||Date.now(),subscribe("updateInterval",update_manager_schedule,!0),chrome.alarms.onAlarm.addListener(update_manager_onAlarm)});const pr={};function getInstallCode(e){const{code:t,timer:n}=pr[e];return clearInstallCode(e),clearTimeout(n),t}function usercss_install_helper_toggle(e,t){t?st.add(maybeInstall):st.delete(maybeInstall);const n=t?[""]:[j,...R,...["greasy","sleazy"].map(e=>`https://update.${e}fork.org/`)];updateDNR([{id:20,condition:{regexFilter:(t?/^.*\.user\.(?:css|less|styl)(?:\?.*)?$/:/^.*\.user\.css$/).source,requestDomains:t?void 0:[...new Set(n.map(e=>e.split("/")[2]))],resourceTypes:["main_frame"],responseHeaders:[{header:"content-type",values:["text/*"],excludedValues:["text/html"]}]},action:{type:"redirect",redirect:{regexSubstitution:chrome.runtime.getURL(E+"#\\0")}}}])}function clearInstallCode(e){return delete pr[e]}function isContentTypeText(e){return/^text\/(?!html)/i.test(e)}async function loadFromFile(e){return(await browser.tabs.executeScript(e,{file:"/content/install-hook-usercss.js"}))[0]}async function loadFromUrl(e,t){return(t.startsWith("file:")||tab_manager_get(e,isContentTypeText.name))&&download(t)}function makeInstallerUrl(e){return`${D}${E}?updateUrl=${encodeURIComponent(e)}`}async function maybeInstall(e,t,n=""){if(t.includes(".user.")&&!1!==tab_manager_get(e,isContentTypeText.name)&&/^(https?|file|ftps?):/.test(t)&&/\.user\.(css|less|styl)$/.test(t.split(/[#?]/,1)[0])&&!n.startsWith(makeInstallerUrl(t))){const n=k&&t.startsWith("file:"),r=await(n?loadFromFile:loadFromUrl)(e,t);!/^\s*</.test(r)&&h.test(r)&&await openInstallerPage(e,t,{code:r,inTab:n})}}async function openInstallerPage(e,t,{code:n,inTab:r}={}){const a=makeInstallerUrl(t);if(r){const t=await browser.tabs.get(e);return openURL({url:`${a}&tabId=${e}`,active:t.active,index:t.index+1,openerTabId:e,currentWindow:null})}const s=safeTimeout(clearInstallCode,1e4,t);pr[t]={code:n,timer:s};try{await browser.tabs.update(e,{url:a})}catch(e){if(/Tabs cannot be edited right now/i.test(e.message))return browser.tabs.create({url:a});throw e}}ee.then(()=>{subscribe("urlInstaller",usercss_install_helper_toggle,!0)});const fr=Object.entries({author:null,description:null,homepageURL:"url",updateURL:"updateUrl",name:null});async function usercss_manager_assign(e,t){const n=e.usercssData,r=t.usercssData,{vars:a}=n,s=r?r.vars:t;if(a&&s){for(const[e,t]of Object.entries(a)){const n=s[e]&&s[e].value;null!=n&&(t.value=n)}n.vars=await u.worker.nullifyInvalidVars(a)}}async function build({styleId:e,sourceCode:t,vars:n,checkDup:r,metaOnly:a,assignVars:s,initialUrl:o}){o&&(t=await download(o));const i=await buildMeta({sourceCode:t}),c=(r||s)&&usercss_manager_find(e?{id:e}:i);let l;return a||((n||s)&&await usercss_manager_assign(i,n||c),await buildCode(i),l=i.log),{style:i,dup:c,log:l}}async function buildCode(e){const{sourceCode:t,usercssData:{vars:n,preprocessor:r}}=e,{sections:a,errors:s,log:o}=await u.worker.compileUsercss(r,t,n),i=s.every(e=>e.recoverable);if(!a.length||!i)throw i?"Style does not contain any actual CSS to apply.":s;return e.sections=a,o&&Object.defineProperty(e,"log",{value:o}),e}async function buildMeta(e){if(e.usercssData)return e;const t=e.sourceCode=e.sourceCode.replace(/\r\n?/g,"\n");e=Object.assign({enabled:!0,sections:[]},e);const n=t.match(h);if(!n)return Promise.reject(new Error("Could not find metadata."));try{const{metadata:t}=await u.worker.parseUsercssMeta(n[0]);e.usercssData=t;for(const[n,r]of fr){const a=t[n];void 0!==a&&(e[r||n]=a)}return e}catch(e){if(e.code){const t="missingMandatory"===e.code||"missingChar"===e.code?e.args.map(e=>1===e.length?JSON.stringify(e):e).join(", "):e.args,r=chrome.i18n.getMessage(`meta_${e.code}`,t);r&&(e.message=r),e.index+=n.index}return Promise.reject(e)}}async function configVars(e,t){const n=util_deepCopy(id2style(e));return n.usercssData.vars=t,await buildCode(n),(await u.styles.install(n,"config")).usercssData.vars}async function usercss_manager_editSave(e){return{log:(e=await parse(e)).log,style:await editSave(e)}}function usercss_manager_find(e){return e.id?id2style(e.id):find(mapObj(e.usercssData||e,null,["name","namespace"]),"usercssData")}function getVersion(e){return usercss_manager_find(e)?.usercssData.version}async function usercss_manager_install(e,t){return install(await parse(e,t))}async function parse(e,{dup:t,vars:n}={}){return e=await buildMeta(e),(t||(t=usercss_manager_find(e)))&&(e.id=t.id),(n||(n=t))&&await usercss_manager_assign(e,n),buildCode(e)}const hr={},getMd5Url=e=>`https://update.userstyles.org/${e}.md5`;function deleteStyle(e){const t=findStyle(e);return!!t&&style_manager_remove(t.id)}function getEmbeddedMeta(e){const t=arguments[0],n=e.includes("@updateURL")&&(t?e:e.replace(h,"")).match(h);return n&&u.usercss.buildMeta({sourceCode:n[0]}).catch(()=>null)}async function getUpdatability(e,t){const n=getMd5Url(e),r=await fetchText(n),a=await findStyle(e,n),s=a?a.usercssData||a.originalMd5===r?2:1:0;return t?{dup:a,md5:r,md5Url:n,state:s}:s}function pingback(t,n){return clearTimeout(hr[t]),delete hr[t],n>0?e.keepAlive(new Promise(e=>hr[t]=setTimeout(ping,n,t,e))):!1!==n?ping(t):void 0}async function toUsercss(e,t,n,r,a,s){let o;r||(r=!1);const{updateUrl:i=makeUpdateUrl("usoa",e)}=r,c=[!r&&getUpdatability(e,!0).then(e=>({dup:r,md5:a,md5Url:s}=e)),!n&&download(i).then(e=>n=e)].filter(Boolean);c[0]&&await Promise.all(c);const{style:l}=await u.usercss.build({sourceCode:n,metaOnly:!0}),d=(o=t||r.updateUrl)&&useVars(l,o,{});if(r)return l;l.md5Url=s,l.originalMd5=a,l.updateUrl=i,await u.usercss.install(l,{dup:r,vars:d})}function useVars(e,t,n){t="string"==typeof t?new URLSearchParams(t.split("?")[1]):Object.entries(t);const{vars:r}=e.usercssData;if(r){for(let[e,a]of t){if(!e.startsWith("ik-"))continue;e=makeKey(e.slice(3),n);const t=r[e];if(t)if(t.options){let s=a.startsWith("ik-")&&optByName(t,makeKey(a.slice(3),n));s||(e+="-custom",s=optByName(t,e+"-dropdown"),s&&(r[e].value=a)),s&&(t.value=s.name)}else t.value=a}return e}}function findStyle(e,t=getMd5Url(e)){return find({md5Url:t})||find({installationUrl:makeInstallUrl("usoa",e)})}async function ping(e,t){return await fetch(`${P}styles/install/${e}?source=stylish-ch`),t&&t(!0),!0}function makeKey(e,t){let n=t[e];if(!n&&e!==(n=e.replace(/[^-\w]/g,"-"))){for(;n in t;)n+="-";t[e]=n}return n}function optByName(e,t){return e.options.find(e=>e.name===t)}const gr=["description","homepage","license","name"],mr=[...gr,"id","namespace","username"],pushId=e=>u.data.set("usw"+e,!0),popId=e=>u.data.del("usw"+e);class yr{constructor(e){this.id=e}keyName(e){return`${e}/${this.id}`}query(e){return Object.assign(e,{vendor_data:this.id})}}function fakeUsercssHeader(e,t){const{namespace:n,username:r}=t||(t={}),a=["name",["@version",(new Date).toISOString().replace(/^(\d+)-(\d+)-(\d+)T(\d+):(\d+).+/,"$1$2$3.$4.$5")],["@namespace","?"!==n&&n||r&&`https://userstyles.world/user/${r}`||"?"],"description",["@homepage",tryURL(n).href],["@author",r],"license"].map((n,r)=>n.map?n[1]&&n:(r=t[n]||e[n])&&["@"+n,r]).filter(Boolean),s=a.reduce((e,[t])=>Math.max(e,t.length),0);return"/* ==UserStyle==\n"+a.map(([e,t])=>`${e}${" ".repeat(s-e.length+2)}${t}\n`).join("")+"==/UserStyle== */\n\n"}async function linkStyle(e,t){const{id:n,name:r}=e,{metadata:a}=await u.worker.parseUsercssMeta(t.match(h)[0]),s={name:r,sourceCode:t,usercssData:{}},o="usw"+n;for(const e of gr)s[e]=s.usercssData[e]=a[e]||"";u.data.set(o,s);try{const t=await getToken("userstylesworld",!0,new yr(n)),r=await uswFetch("style",t),a=mapObj(r,null,e.usercssData?["id"]:mr);return a.token=t,e.url=e.url||r.homepage||`${j}style/${a.id}`,a}finally{u.data.del(o)}}async function uswFetch(e,t,n){return(n=Object.assign({credentials:"omit"},n)).headers=Object.assign({Authorization:`Bearer ${t}`},n.headers),(await(await fetch(`${j}api/${e}`,n)).json()).data}async function uswSave(e,t){const{id:n}=e;t?e._usw=t:t=e._usw,await saveStyle(e,{broadcast:!1}),broadcastExtension({method:"uswData",style:{id:n,_usw:t}})}async function publish(e,t,n){try{pushId(e);const r=id2style(e);n||(n=r._usw),r.usercssData||(t=fakeUsercssHeader(r,n)+t),n&&n.token&&n.id||(n=await linkStyle(r,t));const a=await uswFetch(`style/${n.id}`,n.token,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({code:t})});return deepEqual(n,r._usw)||await uswSave(r,n),a}finally{popId(e)}}async function revoke(e){try{u.data.set("usw"+e,!0),await revokeToken("userstylesworld",new yr(e));const t=id2style(e);t&&(delete t._usw.token,await uswSave(t))}finally{u.data.del("usw"+e)}}async function apiPortMessage({id:e,data:t,TDM:n},r){try{ee[zn]&&await ee,r.sender.TDM=n,t={data:await _execute("extension",t,r.sender)}}catch(e){t=wrapError(e)}t.id=e;try{r.postMessage(t)}catch{}}Object.assign(u,{data:((e={})=>({del:t=>delete e[t],get:t=>e[t],has:t=>t in e,pop:t=>{const n=e[t];return delete e[t],n},set:(t,n)=>{e[t]=n}}))(),info:{get:async()=>({dark:Ye,favicon:k||(re.then?await re:re)}),set(e){let t;null!=(t=e.preferDark)&&Xe(t)}},download,openEditor:async function(e){const t=new URL(chrome.runtime.getURL("edit.html"));t.search=new URLSearchParams(e);const n=F&&Z("openEditInWindow"),r=n&&Z("windowPosition"),a=n&&Z("openEditInWindow.popup")?{type:"popup"}:{},s=n&&k;for(let e,o=0;o<(r?2:1);++o)try{return e=e||await openURL({url:`${t}`,currentWindow:null,newWindow:n&&Object.assign({},a,!s&&!o&&r)}),s&&!o&&await F.update(e.windowId,r),e}catch{}},openManage:async function(e={}){const t=chrome.runtime.getURL("manage.html"),n=setUrlParams(t,e),r=await browser.tabs.query({url:t+"*"}),a=r.find(e=>e.url===n);let s=a||r[0];return s?a||await sendTab(s.id,{method:"pushState",url:setUrlParams(s.url,e)}):(u.prefsDb.get("badFavs"),s=await openURL({url:n,newTab:!0})),activateTab(s)},openURL,pingTab,updateIconBadge,waitForTabUrl:function(e){return new Promise(t=>{browser.tabs.onUpdated.addListener(function onUpdated(n,r,a){r.url&&n===e&&(browser.tabs.onUpdated.removeListener(onUpdated),t(a))},..."UpdateFilter"in browser.tabs?[{tabId:e}]:[])})},prefs:vt,styles:n,sync:a,updater:s,usercss:o,uso:i,usw:c},!1,!1),chrome.runtime.onInstalled.addListener(({reason:e,previousVersion:t})=>{k||(reinjectContentScripts(),initContextMenus()),"install"===e&&(S&&set("manage.newUI",!1),x&&set("editor.keyMap","sublime")),"1.5.30"===t&&u.prefsDb.delete("badFavs"),je.clear();for(const e of[!1,!0])(e?Gt.getDynamicRules():Gt.getSessionRules()).then(t=>updateDNR(void 0,t.map(e=>e.id),e))}),le.both.add((e,t)=>{if("invokeAPI"===e.method){let n=u;for(const t of e.path.split("."))n=n&&n[t];if(!n)throw new Error(`Unknown API.${e.path}`);return n=n.apply({msg:e,sender:t},e.args),void 0===n?null:n}}),chrome.runtime.onConnect.addListener(e=>{"api"===e.name&&(e.onMessage.addListener(apiPortMessage),e.onDisconnect.addListener(ignoreChromeError))}),ee.styles.then(()=>{ee[zn](),ee[zn]=null}),self.oninstall=e=>{e.addRoutes({condition:{urlPattern:`${D}*.html?clientData*`},source:"fetch-event"}),e.addRoutes({condition:{not:{urlPattern:`${D}*.user.css`,requestDestination:"document"}},source:"network"})},self.onfetch=e=>{const t=e.request.url;t.startsWith(D)&&(t.includes("?clientData")?e.respondWith(setClientData(new URL(t).searchParams)):/\.user.css#(\d+)$/.test(t)&&e.respondWith(Response.redirect("edit.html?id="+RegExp.$1)))},self.onmessage=function(e){const{lock:t=location.pathname,id:n}=e.data||{},r=this,a=e.ports[0];async function onMessage(e){const t=e.data,{args:n,id:s}=t.id?t:JSON.parse(t);let o,i;ue&&(clearTimeout(ue),ue=0);try{o=("function"==typeof r?r:r[n.shift()]).apply(e,n),o instanceof Promise&&(o=await o)}catch(e){o=void 0,i=e,delete e.source}a.postMessage({id:s,res:o,err:i},e._transfer)}de||!t||n||(de=!0,navigator.locks.request(t,()=>new Promise(NOP))),a.onerror=console.error,a.onmessage=onMessage,a.onmessageerror=onMessageError,n&&onMessage(e)}.bind(_execute.bind(null,"extension")),u.worker=createPortProxy(async()=>{const[e]=await self.clients.matchAll({type:"window"});return(e?createPortProxy(e,{once:!0}):De).getWorkerPort(C)},{lock:C}),Se.webdav=async e=>{const t=await De.webdavInit(e),n=De.webdav;for(const e in t)t[e]??=n.bind(null,e);return t}})()})()}