{const e=this;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["popup_search_js"],{6670:(t,n,s)=>{s.r(n);var r=s(6001),o=s(9030),a=s(6308),l=s(9204),c=s(2691),i=s(1679),u=s(9521),d=s(4188),h=s(3751);document.body.append(a.template.searchUI);const p=a.template.searchResult.className+"-",f="."+a.template.searchResult.className,y=i.usoaRaw[0]+"search-index.json",g=i.usw+"api/index/uso-format",m=(0,r.$create)("img",{src:`${i.usw}favicon.ico`,title:i.usw}),$="chrome-extension",b=100,w="-after.png",x={},I=(0,r.$)("#popup.search.globals");let _,C,v;(0,o.setupLivePrefs)([I.id]);let A,R,k,S="",F="",N=I.checked,U=[],L=c.get("popup.findSort"),E=!0,M=1,j=1,B=".jpeg";(0,r.$create)("img",{src:"data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA=",onload:()=>B=".webp"});const $resultEntry=e=>{const t=e.closest(f);return{entry:t,result:t&&t._result}},rid2id=e=>e.split("-")[1],P={styleAdded:onStyleInstalled,styleUpdated:onStyleInstalled,styleDeleted:function({style:{id:e}}){const t=_.find(t=>t._styleId===e);t&&(t.f&&l.API.uso.pingback(rid2id(t.i),!1),delete t._styleId,renderActionButtons(t.i))}};d.styleFinder.on=async(e,t)=>{const n=P[e.method];if(n)return t&&await t,n(e)},d.styleFinder.inline=()=>{calcCategory(),R=start()},d.styleFinder.inSite=e=>{F||calcCategory({retry:1});const add=(e,t)=>t?e+t:"",t=e.detail,n=encodeURIComponent((0,r.$)("#search-query").value.trim()),s=F+add("+",n),o="uso"===t&&`${i.uso}styles/browse${n?`?search_terms=${s}`:`/${F}`}`||"usoa"===t&&`${i.usoa}browse/styles?search=%23${s}`||"usw"===t&&`${i.usw}search?q=${s}`||"gf"===t&&"https://greasyfork.org/"+(r.$.root.lang.split("-")[0]||"en")+`/scripts/by-site/${(0,u.tryURL)(d.tabURL).hostname.replace(/^www\./,"")}?language=css${add("&q=",n)}`;h.openURLandHide.call({href:o},e)},I.onchange=function(){N=this.checked,R=R.then(start)},(0,r.$)("#search-query").oninput=function(){U=[];const e=this.value.trim();for(let t,n=/(")(.+?)"|((\/)?(\S+?)(\/\w*)?)(?=\s|$)/g;t=n.exec(e);){const[e,n,s,r,o="",a,l=""]=t;U.push(o&&l&&(0,u.tryRegExp)(a,l.slice(1))||(0,u.stringAsRegExp)(n?s:r,e===e.toLocaleLowerCase()?"i":""))}F===$&&U.push(/\bStylus\b/),R=R.then(start)},(0,r.$)("#search-years").onchange=()=>{R=R.then(()=>start({keepYears:!0}))},(0,r.$)("#search-order").value=L,(0,r.$)("#search-order").onchange=function(){L=this.value,c.set("popup.findSort",L),_.sort(comparator),render()},x.list=(0,r.$)("#search-results-list"),x.container=(0,r.$)("#search-results"),x.container.dataset.empty="",x.error=(0,r.$)("#search-results-error"),x.nav={};const D={prev:function(){M=Math.max(1,M-1),E=!0,render()},next:function(){M=Math.min(j,M+1),E=!0,render()}};for(const e of["top","bottom"]){const t=(0,r.$)(`.search-results-nav[data-type="${e}"]`);t.appendChild(a.template.searchNav.cloneNode(!0)),x.nav[e]=t;for(const e of(0,r.$$)("[data-type]",t)){const n=e.dataset.type;e.onclick=D[n],t["_"+n]=e}}async function onStyleInstalled({style:e}){const t=await l.API.styles.getRemoteInfo(e.id),n=t&&_.find(e=>t[0]===e.i);n&&(n._styleId=e.id,n._styleVars=t[1],renderActionButtons(t[0]))}function error(e){x.error.textContent=e&&e.message||`${e}`,x.error.hidden=!1,x.list.hidden=!0,x.error.getBoundingClientRect().bottom<0&&x.error.scrollIntoView(!0)}function errorIfNoneFound(){if(!_.length&&!(0,r.$)("#search-query").value)return k?k.then(errorIfNoneFound):Promise.reject((0,a.t)("searchResultNoneFound"))}async function start({keepYears:e}={}){try{_=[];for(let e=0;!_.length&&e<=2;e++)_=await search({retry:e});if(_.length){const e=await l.API.styles.getRemoteInfo();for(const t of _)[t._styleId,t._styleVars]=e[t.i]||[]}e||(C=_),renderYears(),render(),x.list.hidden=!_.length,await errorIfNoneFound(),r.$.rootCL.add("search-results-shown"),x.container.hidden=!1,x.list.hidden=!1,x.error.hidden=!0,_.length&&doScrollToFirstResult()}catch(e){error(e)}}function renderYears(){const e=new Date(0).getFullYear(),t=1/365.2425,n=[];for(const s of C){let r=s._year;r||(r=s.u/31556952+e,s._year=r=Math.abs(r%1-1)<=t?new Date(1e3*s.u).getFullYear():0|r),n[r]=(n[r]||0)+1}const s=n.reduceRight((e,t,n)=>e.push(`${n} (${t})`)&&e,[]),o=[...(0,r.$$)("#search-years select")];o.forEach((e,t)=>{if(s.length!==e.length||s.some((t,n)=>t!==e[n].text)){const n=e.selectedIndex,o=n&&n<e.length-1&&e.value;e.textContent="",e.append(...s.map(e=>(0,r.$create)("option",{value:e.split(" ")[0]},e))),e.value=o||e[(t?"first":"last")+"Child"]?.value}});const[a,l]=o.map(e=>Number(e.value)).sort();_=a?C.filter(e=>(e=e._year)>=a&&e<=l):C}function render(){j=Math.ceil(_.length/b),M=Math.min(M,j)||1;let e=(M-1)*b;const t=M*b;let n=0,s=x.list.children[0];for(;n<b&&s&&s.id===p+_[e]?.i;)s=s.nextElementSibling,n++,e++;for(;e<Math.min(t,_.length);){const t=createSearchResultNode(_[e++]);s?(x.list.replaceChild(t,s),s=t.nextElementSibling):x.list.appendChild(t),n++}const r=t>_.length&&_.length%b||Math.min(_.length,b);for(;x.list.children.length>r;)x.list.lastElementChild.remove();_.length&&"empty"in x.container.dataset&&delete x.container.dataset.empty,E&&(0,u.debounce)(doScrollToFirstResult);for(const e in x.nav){const t=x.nav[e];t._prev.disabled=M<=1,t._next.disabled=M>=j,t._page.textContent=M,t._total.textContent=j,t._num.textContent=_.length}}function doScrollToFirstResult(){x.container.scrollHeight>2*e.innerHeight&&(E=!1,x.container.scrollIntoView(!0))}function createSearchResultNode(e){const t=a.template.searchResult.cloneNode(!0),{i:n,n:s,r:o,u:l,w:c,t:d,ai:f,an:y,sa:g,sn:$,f:b}=t._result=e,x=rid2id(n);t.id=p+n,Object.assign((0,r.$)(".search-result-title",t),{onclick:h.openURLandHide,href:`${b?i.usoa:i.usw}style/${x}`}),b||(0,r.$)(".search-result-title",t).prepend(m.cloneNode(!0)),(0,r.$)(".search-result-title span",t).textContent=(0,a.breakWord)((0,u.clipString)(s,300));const I=(0,r.$)(".search-result-screenshot",t);let _;return b?(I._src=i.uso+`auto_style_screenshots/${x}${w}`,_=$&&!$.endsWith(w)?`${g?i.usoaRaw[0]:i.uso+"style_"}screenshots/${$}`:I._src):_=/^https?:/i.test($)&&$.replace(/\.\w+$/,B),_?(I._entry=t,I.src=_,I.onerror=fixScreenshot):t.dataset.noImage="",Object.assign((0,r.$)('[data-type="author"] a',t),{textContent:y,title:y,href:b?`${i.usoa}browse/styles?search=%40${f}`:`${i.usw}user/${encodeURIComponent(y)}`,onclick:h.openURLandHide}),(0,r.$)('[data-type="rating"]',t).dataset.class=o?o>=2.5?"good":o>=1.5?"okay":"bad":"none",(0,r.$)('[data-type="rating"] dd',t).textContent=o&&o.toFixed(1)||"",Object.assign((0,r.$)('[data-type="updated"] time',t),{dateTime:1e3*l,textContent:(0,a.formatDate)(1e3*l)}),(0,r.$)('[data-type="weekly"] dd',t).textContent=formatNumber(c),(0,r.$)('[data-type="total"] dd',t).textContent=formatNumber(d),renderActionButtons(t),t}function formatNumber(e){return e>1e9?(e/1e9).toFixed(1)+"B":e>1e7?(e/1e6).toFixed(0)+"M":e>1e6?(e/1e6).toFixed(1)+"M":e>1e4?(e/1e3).toFixed(0)+"k":e>1e3?(e/1e3).toFixed(1)+"k":e}function fixScreenshot(){const{_src:e}=this;e&&e!==this.src?(this.src=e,delete this._src):(this.onerror=null,this.removeAttribute("src"),this._entry.dataset.noImage="",renderActionButtons(this._entry))}function renderActionButtons(e){if("object"!=typeof e&&(e=(0,r.$)("#"+p+e)),!e)return;const t=e._result,n=t._styleId,s=n>0,o=(0,r.$)(".search-result-status",e).textContent=s?(0,a.t)("clickToUninstall"):null!=e.dataset.noImage?(0,a.t)("installButton"):"",l=s&&!(0,d.$entry)(n);l!==e.classList.contains("not-matching")&&(e.classList.toggle("not-matching"),l?e.prepend(a.template.searchResultNotMatching.cloneNode(!0)):e.firstElementChild.remove()),Object.assign((0,r.$)(".search-result-screenshot",e),{onclick:s?uninstall:install,title:o?"":(0,a.t)("installButton")}),(0,r.$)(".search-result-uninstall",e).onclick=uninstall,(0,r.$)(".search-result-install",e).onclick=install,Object.assign((0,r.$)(".search-result-customize",e),{onclick:configure,disabled:l}),(0,r.toggleDataset)(e,"installed",s),(0,r.toggleDataset)(e,"customizable",t._styleVars)}function renderFullInfo(e,t){let{description:n,vars:s}=t.usercssData;n=(n||"").replace(/<[^>]*>/g," ").replace(/([^.][.ã€‚?!]|[\s,].{50,70})\s+/g,"$1\n").replace(/([\r\n]\s*){3,}/g,"\n\n"),(0,r.$)(".search-result-description",e).textContent=n,s=!(0,u.isEmptyObj)(s),e._result._styleVars=s,(0,r.toggleDataset)(e,"customizable",s)}function configure(){const e=(0,d.$entry)($resultEntry(this).result._styleId);h.configure.call(this,{},e)}async function install(){const{entry:e,result:t}=$resultEntry(this),{f:n}=t,s=rid2id(t.i),c=(0,r.$)(".search-result-install",e);(0,o.showSpinner)(e),c.disabled=!0,e.style.setProperty("pointer-events","none","important"),delete e.dataset.error,n&&l.API.uso.pingback(s,5e3);const u=i.makeUpdateUrl(n?"usoa":"usw",s);try{const t=await(await fetch(u)).text();renderFullInfo(e,await l.API.usercss.install({sourceCode:t,updateUrl:u}))}catch(t){e.dataset.error=`${(0,a.t)("genericError")}: ${t&&t.message||t}`,e.scrollIntoView({behavior:"smooth",block:"nearest"})}(0,r.$remove)(".lds-spinner",e),c.disabled=!1,e.style.pointerEvents=""}function uninstall(){const{result:e}=$resultEntry(this);l.API.styles.remove(e._styleId)}function calcCategory({retry:e}={}){const t=(0,u.tryURL)(d.tabURL),n=F;if(t.href)if("file:"===t.protocol)F="file:";else if(t.protocol===location.protocol)F=$;else{const n=t.hostname.replace(/\.(?:com?|org)(\.\w{2,3})$/,"$1").split("."),[s,r=t.hostname,o,a]=n.reverse(),l=!e&&(a||o&&"www"!==o&&"m"!==o);F=(l&&`${o}.`||"")+r+(1!==e&&"com"!==s&&("org"!==s||"userstyles"===r)||l?`.${s}`:""),S||(S=l&&F)}else F="";return A=new RegExp(`\\b${(0,u.stringAsRegExpStr)(F)}\\b`,"i"),F!==n}async function fetchIndex(){const e=(0,r.$)("#pct").firstChild,t=[[y,"uso",e=>e.filter(e=>"uso"===e.f)],[g,"usw",e=>e.data]].map(fetchIndexJob);return k=Promise.all(t).then(()=>{k=null,e.style.opacity=0}),await Promise.race(t),v}async function fetchIndexJob([e,t,n]){let s=(0,r.$create)({title:e});(0,r.$)("#pct").append(s),chrome.runtime.onConnect.addListener(t=>{t.name===e&&t.onMessage.addListener(([e,t])=>{s&&(s.textContent=t?(e/t*100|0)+"%":formatNumber(e)+"...")})});for(let s=3;s--;)try{const s=n(await l.API.download(e,{responseType:"json",port:e}));for(const e of s)e.i=`${t}-${e.i}`;v?(v=v.concat(s),R.then(start)):v=s;break}catch(e){s?await(0,u.sleep)(250):error(e.message)}s=s.style.opacity=0}async function search({retry:e}={}){return!e||U.length||calcCategory({retry:e})?(v||await fetchIndex()).filter(isResultMatching).sort(comparator):[]}function isResultMatching(e){const{c:t}=e;let n;return(n=t===F||S&&(t.includes(".")?46===S.charCodeAt(S.length-t.length-1)&&S.endsWith(t):S.includes(`.${t}.`))&&2+!e.n.includes(S)||(F===$?"stylus"===t:"global"===t&&N&&(U.length||A.test(e.n))))&&U.every(isInHaystack,e)&&(e._bias=n)}function isInHaystack(e){return e.test(this.n)}function comparator(e,t){return e._bias-t._bias||("n"===L?e.n<t.n?-1:e.n>t.n:t[L]-e[L])||t.t-e.t}}}])}