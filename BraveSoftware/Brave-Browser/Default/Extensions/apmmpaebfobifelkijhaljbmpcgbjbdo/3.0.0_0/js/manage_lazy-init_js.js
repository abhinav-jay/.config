{const e=this;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["manage_lazy-init_js"],{213:(t,n,a)=>{var s=a(6001),o=a(9030),i=a(6308),l=a(9521);const r="draggable-list-transformed";function posToIndex(e,t,n,a){if(n<e[0].top&&a)return t;for(let a=0;a<t;a++)if(!(e[a].bottom<n))return a;if(n>e[e.length-1].bottom&&a)return t;for(let a=e.length-1;a>t;a--)if(!(e[a].top>n))return a;return t}function applyTransform(e,t,n,a,s){function transform(t,n,a,s){for(let o=n;o<=a;o++)t&&!e[o].classList.contains(r)?(e[o].classList.add(r),e[o].style.transform=s):!t&&e[o].classList.contains(r)&&(e[o].classList.remove(r),e[o].style="")}a>n?(transform(!1,n,Math.min(t-1,a-1)),t<e.length-1&&transform(!0,Math.max(n+1,t+1),a,`translateY(${-s}px)`)):(transform(!1,Math.max(t+1,a+1),n),t>0&&transform(!0,a,Math.min(n-1,t-1),`translateY(${s}px)`))}function DraggableList(t,{bound:n,scrollContainer:a}={}){for(const e of t.children)e.draggable=!0;new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)e.draggable=!0}).observe(t,{childList:!0});let s=null,o=0,i=0,l=null,d=[],c=null,p=!1,u=0;function dispatch(e,n,a){const o={origin:e,startPos:s,currentPos:l,dragTarget:c};a&&Object.assign(o,a),t.dispatchEvent(new CustomEvent(n,{detail:o}))}t.addEventListener("dragstart",n=>{if(n.target.parentNode!==t)return;c=n.target,p=!1;const r=a?a.scrollLeft:0,m=a?a.scrollTop:0;s={x:n.pageX+r,y:n.pageY+m},o=[...t.children].indexOf(n.target),i=o,l=s,d=[...t.children].map(t=>{const n=t.getBoundingClientRect();return{top:n.top+e.scrollY+m,bottom:n.bottom+e.scrollY+m}}),u=o+1<d.length?d[o+1].top-d[o].top:o>0?d[o].bottom-d[o-1].bottom:0,c.classList.add("draggable-list-target"),t.classList.add("draggable-list-dragging"),dispatch(n,"d:dragstart")}),t.addEventListener("dragenter",e=>{c&&(e.preventDefault(),dispatch(e,"d:dragmove"))}),t.addEventListener("dragover",e=>{if(!c)return;e.preventDefault();const s=a?a.scrollLeft:0,r=a?a.scrollTop:0,p={x:e.pageX+s,y:e.pageY+r},m=posToIndex(d,o,p.y,n);applyTransform(t.children,o,i,m,u),i=m,l=p,dispatch(e,"d:dragmove")}),document.addEventListener("dragend",e=>{if(c){for(const e of t.children)e.classList.remove(r),e.style="";c.classList.remove("draggable-list-target"),t.classList.remove("draggable-list-dragging"),dispatch(e,"d:dragend",{originalIndex:o,spliceIndex:i,insertBefore:i<o?t.children[i]:t.children[i+1],dropped:p}),c=null}}),t.addEventListener("drop",e=>{c&&(p=!0,e.preventDefault())})}var d=a(9204),c=a(7088),p=a(2691),u=a(6981),m=a(2062),g=a(7286),h=a(1976);const f=(0,s.$)("#check-all-updates"),y=(0,s.$)("#check-all-updates-force"),b=(0,s.$)("#apply-all-updates");function checkUpdate(e,{single:t}={}){(0,s.$)(".update-note",e).textContent=(0,i.t)("checkingForUpdate"),(0,s.$)(".check-update",e).title="",t&&d.API.updater.checkStyle({save:!1,id:e.styleId,ignoreDigest:e.classList.contains("update-problem")}).then(reportUpdateState),e.classList.remove("checking-update","no-update","update-problem"),e.classList.add("checking-update")}function reportUpdateState({updated:e,style:t,error:n,STATES:a}){const o=document.body.classList.contains("update-in-progress"),l=(0,h.$entry)(t),r=new Map([["updatable",!0],["checking-update",0],["update-done",0],["install-done",0],["no-update",0],["update-problem",0]]);if(e)r.set("can-update",!0),l.updatedCode=t,(0,s.$)(".update-note",l).textContent="",(0,s.$)("#only-updates").classList.remove("hidden");else if(!l.classList.contains("can-update")){const e=n===a.SAME_MD5||n===a.SAME_CODE||n===a.SAME_VERSION,d=n===a.EDITED||n===a.MAYBE_EDITED;n?"number"==typeof n?n=(0,i.t)("updateCheckFailBadResponseCode",[n])+"\n"+t.updateUrl:n===a.EDITED?n=(0,i.t)("updateCheckSkippedLocallyEdited")+"\n"+(0,i.t)("updateCheckManualUpdateHint"):n===a.MAYBE_EDITED?n=(0,i.t)("updateCheckSkippedMaybeLocallyEdited")+"\n"+(0,i.t)("updateCheckManualUpdateHint"):"object"==typeof n&&n.message?n=n.message:Array.isArray(n)&&(n=n.map(e=>`${e.message||e}${e.context?"\n"+e.context.replace(/^/gm,"\t"):""}`).join("\n")):n=(0,i.t)("updateCheckFailServerUnreachable")+"\n"+t.updateUrl,l.dataset.error=n;const c=e?(0,i.t)("updateCheckSucceededNoUpdate"):n;if(r.set("no-update",!0),r.set("update-problem",!e),(0,s.$)(".update-note",l).textContent=c,(0,s.$)(".check-update",l).title=h.newUI.cfg.enabled?c:"",(0,s.$)(".update",l).title=(0,i.t)(d?"updateCheckManualUpdateForce":"installUpdate"),n===a.SAME_CODE)for(const e of chrome.extension.getViews({type:"tab"}))if(e.location.pathname===location.pathname){const n=(0,h.$entry)(t,e.document);n&&(n.styleMeta.originalDigest=t.originalDigest)}o||renderUpdatesOnlyFilter({show:(0,s.$)(".can-update, .update-problem")})}const d=new Map([...l.classList.values()].map(e=>[e,!0]));for(const[e,t]of r)d.set(e,t);const c=[...d].map(([e,t])=>t&&e).filter(Boolean).join(" ");c!==l.className&&(l.className=c),m.filtersSelector.hide&&o?(0,m.filterAndAppend)({entry:l}).then(g.updateStripes):e&&!o&&renderUpdatesOnlyFilter()}function renderUpdatesOnlyFilter({show:e,check:t}={}){const n=(0,s.$$)(".can-update").length,a=n>0||(0,s.$)(".update-problem"),o=(0,s.$)("#only-updates input");e=void 0!==e?e:a,t=void 0!==t?e&&t:o.checked&&a,(0,s.$)("#only-updates").classList.toggle("hidden",!e),o.checked=t&&e,o.dispatchEvent(new Event("change")),b.classList.toggle("hidden",!n),b.dataset.value=n}function handleUpdateInstalled(e,t){const n="install"===t,a=(0,i.t)(n?"installButtonInstalled":"updateCompleted");e.classList.add("update-done",...n?["install-done"]:[]),e.classList.remove("can-update","updatable"),(0,s.$)(".update-note",e).textContent=a,(0,s.$)(".updated",e).title=a,renderUpdatesOnlyFilter()}f.onclick=y.onclick=function(){document.body.classList.add("update-in-progress");const e=(0,s.$)("#update-all-no-updates");f.disabled=!0,y.classList.add("hidden"),b.classList.add("hidden"),e.classList.add("hidden");const t=this===y;(0,s.$$)(".updatable:not(.can-update)"+(t?"":":not(.update-problem)")).forEach(checkUpdate);let n=0,a=0,o=0,i=0;function observer(t,l){"count"in t&&(n=t.count),t.updated&&(1==++i&&(b.disabled=!0),b.dataset.value=i),(t.updated||"error"in t)&&(a++,o+=!t.updated&&[t.STATES.EDITED,t.STATES.MAYBE_EDITED].includes(t.error),reportUpdateState(t));const r=(0,s.$)("#update-progress"),d=r.parentElement.clientWidth;r.style.width=Math.round(a/n*d)+"px",t.done&&(l.onMessage.removeListener(observer),document.body.classList.remove("update-in-progress"),f.disabled=0===n,b.disabled=!1,renderUpdatesOnlyFilter({check:i+o>0}),i||(e.dataset.skippedEdited=o>0,e.classList.remove("hidden"),y.classList.toggle("hidden",0===o)))}chrome.runtime.onConnect.addListener(function onConnect(e){"updater"===e.name&&(e.onMessage.addListener(observer),chrome.runtime.onConnect.removeListener(onConnect))}),d.API.updater.checkAllStyles({save:!1,observe:!0,ignoreDigest:t})},b.onclick=function(){b.disabled=!0,setTimeout(()=>{b.classList.add("hidden"),b.disabled=!1,renderUpdatesOnlyFilter({show:!1})},1e3),(0,s.$$)(".can-update .update").forEach(e=>{(0,o.scrollElementIntoView)(e),e.click()})},p.subscribe("updateOnlyEnabled",(e,t)=>{f.title=t?(0,i.t)("manageOnlyEnabled"):""},!0);var v=a(4523),E=a(6413);for(const e of(0,s.$$)('#header a[href^="http"]'))e.onclick=openLink;h.installed.on("click",onEntryClicked),h.installed.on("contextmenu",onEntryClicked),e.on("pageshow",handleVisibilityChange),e.on("pagehide",handleVisibilityChange),(0,d.onExtension)(e=>{switch(e.method){case"styleUpdated":case"styleAdded":case"styleDeleted":h.queue.push(e),h.queue.time?(0,l.debounce)(handleBulkChange,h.queue.THROTTLE):handleBulkChange(h.queue)}});const $=".applies-to .expander",k={"input, .enable, .disable"(e,t){d.API.styles.toggle(t.styleId,this.matches(".enable")||this.checked)},".style-name"(e,t){h.newUI.cfg.enabled&&!e.target.closest(".homepage")&&edit(e,t)},".homepage":openLink,".check-update"(e,t){checkUpdate(t,{single:!0})},".update"(e,t){const n=t.updatedCode;n.id=t.styleId,(n.usercssData?d.API.usercss.install:d.API.styles.install)(n)},async".delete"(e,t){const n=t.styleId;(0,o.animateElement)(t);const{button:a}=await o.messageBox.show({title:(0,i.t)("deleteStyleConfirm"),contents:t.styleMeta.customName||t.styleMeta.name,className:"danger center",buttons:[(0,i.t)("confirmDelete"),(0,i.t)("confirmCancel")]});0===a&&d.API.styles.remove(n);const l=(0,s.$)("#message-box-buttons > button");l&&l.removeAttribute("data-focused-via-click")},".configure-usercss"(e,{styleMeta:t}){(0,o.configDialog)(t)},[$]:expandTargets},w={[$]:expandTargets};async function edit(e,t){if(e.altKey)return;e.preventDefault(),e.stopPropagation();const n=(0,o.getEventKeyName)(e),a=(0,s.$)("[href]",t).href,i=await(0,v.getOwnTab)();"MouseL"===n?(l.sessionStore["manageStylesHistory"+i.id]=a,location.href=a):v.browserWindows&&"Shift-MouseL"===n?d.API.openEditor({id:t.styleId}):d.API.openURL({url:a,index:i.index+1,active:"Shift-MouseM"===n||"Shift-Ctrl-MouseL"===n})}function expandTargets(e,t){if("contextmenu"!==e.type)t._allTargetsRendered||((0,E.createTargetsElement)({entry:t,expanded:!0}),(0,E.renderFavs)(t)),this.closest(".applies-to").classList.toggle("expanded");else{e.preventDefault();const n=".expanded";(0,s.$$)(`.has-more${(0,s.$)(n,t)?n:`:not(${n})`} .expander`).forEach(e=>e.click())}}async function openLink(e){if("Shift-MouseL"!==(0,o.getEventKeyName)(e)){e.preventDefault();const{index:t}=await(0,v.getOwnTab)();d.API.openURL({url:e.target.closest("a").href,index:t+1,active:!e.ctrlKey||e.shiftKey})}}function onEntryClicked(e){const t=e.target,n=t.closest(".entry"),a="contextmenu"===e.type?w:k;for(const s in a)for(let o=t;o&&o!==n;o=o.parentElement)if(o.matches(s))return a[s].call(o,e,n)}function handleBulkChange(e=h.queue){for(const t of e){const{id:n}=t.style;let a;"styleDeleted"===t.method?handleDelete(n):"import"===t.reason&&(a=e.styles.get(n))?(handleUpdate(a,t),e.styles.delete(n)):handleUpdateForId(n,t)}g.updateStripes({onlyWhenColumnsChanged:!0}),e.time=performance.now(),e.length=0}function handleDelete(e){const t=(0,h.$entry)(e);if(t){if(t.remove(),t.matches(".can-update")){const e=(0,s.$)("#apply-all-updates");e.dataset.value=Number(e.dataset.value)-1}(0,m.showFiltersStats)(),(0,E.updateTotal)(-1)}}function handleUpdate(e,{reason:t,method:n}={}){if("editPreview"===t||"editPreviewEnd"===t)return;let a,i=(0,h.$entry)(e);i&&"styleUpdated"===n&&function(){(0,h.removeStyleCode)(e);const t=(0,h.objectDiff)(i.styleMeta,e).filter(({key:e,path:t})=>t||!/^_|(Date|Digest|Md5)$/.test(e));0===t.length&&(a=i,i=null),1===t.length&&"enabled"===t[0].key&&(i.classList.toggle("enabled",e.enabled),i.classList.toggle("disabled",!e.enabled),(0,s.$$)("input",i).forEach(t=>t.checked=e.enabled),i.styleMeta=e,a=i,i=null)}(),a=a||(0,E.createStyleElement)((0,h.styleToDummyEntry)(e)),i?i.styleNameLC===a.styleNameLC?h.installed.replaceChild(a,i):i.remove():(0,E.updateTotal)(1),"update"!==t&&"install"!==t||!a.matches(".updatable")||handleUpdateInstalled(a,t),(0,m.filterAndAppend)({entry:a}).then(g.update),a.matches(".hidden")||"import"===t||"sync"===t||((0,o.animateElement)(a),requestAnimationFrame(()=>(0,o.scrollElementIntoView)(a))),(0,E.renderFavs)(a)}async function handleUpdateForId(e,t){handleUpdate(await d.API.styles.get(e),t)}function handleVisibilityChange(t){const n=Number(l.sessionStore.justEditedStyleId);"pageshow"===t.type&&t.persisted&&n?(handleUpdateForId(n,{method:"styleUpdated"}),delete l.sessionStore.justEditedStyleId):"pagehide"===t.type&&history.replaceState({scrollY:e.scrollY},document.title)}var L=a(7209),C=a(7394),x=a(4435);async function importFromFile(e){let t,n;const a=h.queue,s=document.createElement("input"),r=new Promise((...e)=>[t,n]=e);try{e?readFile():(s.style.display="none",s.type="file",s.accept="application/json"+(x.MOBILE?",text/plain":""),s.acceptCharset="utf-8",document.body.appendChild(s),s.initialValue=s.value,s.onchange=readFile,s.click());const t=await r;if(s.remove(),/^\s*\[/.test(t))a.time=performance.now(),await importFromString(t),a.time=0,setTimeout(()=>a.styles.clear(),2*a.THROTTLE);else if(l.RX_META.test(t))throw(0,i.t)("dragDropUsercssTabstrip")}catch(e){o.messageBox.alert(e.message||e)}function readFile(){if(!e){if(s.value===s.initialValue)return t("");e=s.files[0]}if(e.size>1e9)return n((e.size/1e9).toFixed(1).replace(".0","")+"GB backup? I don't believe you.");const a=new FileReader;a.onloadend=()=>t(a.result),a.onerror=n,a.readAsText(e,"utf-8")}}async function importFromString(e){const t=JSON.parse(e),n=Array.isArray(t)&&t.length?await d.API.styles.getAll():[],a=new Map(n.map(e=>[e.id,e])),r=new Map(n.map(e=>[e._id,e])),c=new Map(n.map(e=>[e.name.trim(),e])),u=await d.API.styles.getOrder(),m=[],g=Symbol("info"),f={options:{names:[],isOptions:!0,legend:"optionsHeading"},added:{names:[],ids:[],legend:"importReportLegendAdded",dirty:!0},unchanged:{names:[],ids:[],legend:"importReportLegendIdentical"},metaAndCode:{names:[],ids:[],legend:"importReportLegendUpdatedBoth",dirty:!0},metaOnly:{names:[],ids:[],legend:"importReportLegendUpdatedMeta",dirty:!0},codeOnly:{names:[],ids:[],legend:"importReportLegendUpdatedCode",dirty:!0},invalid:{names:[],legend:"importReportLegendInvalid"}};let y;await Promise.all(t.map(function(e,t){if(e&&!e.id&&e[p.STORAGE_KEY])return analyzeStorage(e);if(!e||"object"!=typeof e||((0,l.isEmptyObj)(e.usercssData)?!(0,C.styleJSONseemsValid)(e):"string"!=typeof e.sourceCode))return void f.invalid.names.push(`#${t}: ${(0,l.clipString)(e&&e.name||"")}`);e.name=e.name.trim();const n=a.get(e.id),s=r.get(e._id),o=c.get(e.name);c.delete(e.name);let i=s;!i&&n&&(sameStyle(n,e)?i=n:delete e.id),!i&&o&&(e.id=o.id,i=o);const d=i&&(0,l.deepEqual)(i,e,["sections","sourceCode","_rev"]),u=i&&sameCode(i,e);if(d&&u)f.unchanged.names.push(i.name),f.unchanged.ids.push(i.id);else{const t=m.length-1,n=m[t];(!n||n.length>=30?m[t+1]=[]:n).push(e),e[g]={oldStyle:i,metaEqual:d,codeEqual:u}}}));for(let e=0;e<m.length;e++){const t=m[e],n=await d.API.styles.importMany(t);for(let e=0;e<n.length;e++){const{style:a,err:s}=n[e],o=t[e];a&&h.queue.styles.set(a.id,a),updateStats(a||o,o[g],s)}}return await d.API.styles.setOrder(y),function(){scrollTo(0,0);const e=Object.entries(f),t=e.reduce((e,[,t])=>e+(t.dirty?t.names.length:0),0),n=e.map(renderStats).filter(Boolean);o.messageBox.show({title:(0,i.t)("importReportTitle"),className:"center-dialog",contents:(0,s.$create)("#import",n.length?n:(0,i.t)("importReportUnchanged")),buttons:[(0,i.t)("confirmClose"),t&&(0,i.t)("undo")],onshow:bindClick}).then(({button:e})=>{1===e&&undo()})}();async function analyzeStorage(e){analyzePrefs(e[p.STORAGE_KEY],p.knownKeys,p.__values,!0),delete e[p.STORAGE_KEY],y=e.order,delete e.order,(0,l.isEmptyObj)(e)||analyzePrefs(e,Object.values(L.LZ_KEY),await L.getLZValues())}function analyzePrefs(e,t,n,a){for(const[s,o]of Object.entries(e||{})){const e=t.includes(s);e&&(0,l.deepEqual)(o,n[s])||f.options.names.push({name:s,val:o,isValid:e,isPref:a})}}function sameCode(e,t){const n=e.usercssData,a=t.usercssData;return!n+!a?(0,C.styleSectionsEqual)(e,t):e.sourceCode===t.sourceCode&&(0,l.deepEqual)(n.vars,a.vars)}function sameStyle(e,t){return e.name.trim()===t.name.trim()||["updateUrl","originalMd5","originalDigest"].some(n=>e[n]&&e[n]===t[n])}function updateStats(e,{oldStyle:t,metaEqual:n,codeEqual:a},s){return s?(s=(Array.isArray(s)?s:[s]).map(e=>e.message||e).join(", "),void f.invalid.names.push(e.name+" - "+s)):t?n||a?a?(f.metaOnly.names.push(reportNameChange(t,e)),void f.metaOnly.ids.push(e.id)):(f.codeOnly.names.push(e.name),void f.codeOnly.ids.push(e.id)):(f.metaAndCode.names.push(reportNameChange(t,e)),void f.metaAndCode.ids.push(e.id)):(f.added.names.push(e.name),void f.added.ids.push(e.id))}function renderStats([e,{ids:t,names:n,legend:a,isOptions:o}]){if(!n.length)return;let l;return o&&n.some(e=>e.isValid)&&(l=(0,s.$create)("button",(0,i.t)("importLabel")),importOptions.call(l)),(0,s.$create)("details",{"data-id":e,open:o},[(0,s.$create)("summary",(0,s.$create)("b",(o?"":n.length+" ")+(0,i.t)(a))),(0,s.$create)("small",n.map(t?listItemsWithId:o?listOptions:listItems,t)),l])}function listOptions({name:e,isValid:t}){return(0,s.$create)(t?"div":"del",e+(t?"":` (${(0,i.t)(f.invalid.legend)})`))}function listItems(e){return(0,s.$create)("div",e)}function listItemsWithId(e,t){return(0,s.$create)("div",{"data-id":this[t]},e)}async function importOptions(){const e=await L.get();for(const{name:e,val:t,isValid:n,isPref:a}of f.options.names)n&&(a?p.set(e,t):L.setLZValue(e,t));const t=this.textContent;return this.textContent=(0,i.t)("undo"),this.onclick=async()=>{const n=Object.keys(await L.get()).filter(t=>!(0,l.hasOwn)(e,t));await L.set(e),await L.remove(n),this.textContent=t,this.onclick=importOptions},this}async function undo(){const e=[...f.metaAndCode.ids,...f.metaOnly.ids,...f.codeOnly.ids,...f.added.ids];await Promise.all(e.map(e=>d.API.styles.remove(e))),await d.API.styles.importMany(e.map(e=>a.get(e)).filter(Boolean)),await d.API.styles.setOrder(u),await o.messageBox.show({title:(0,i.t)("importReportUndoneTitle"),contents:e.length+" "+(0,i.t)("importReportUndone"),buttons:[(0,i.t)("confirmClose")]})}function bindClick(){const highlightElement=e=>{const t=(0,s.$)("#style-"+e.target.dataset.id);t&&((0,o.scrollElementIntoView)(t),(0,o.animateElement)(t))};for(const e of(0,s.$$)("#message-box details"))"invalid"!==e.dataset.id&&(e.style.cursor="pointer",e.onclick=highlightElement)}function reportNameChange(e,t){return t.name!==e.name?e.name+" —> "+t.name:e.name}}async function exportToFile(e){e.preventDefault();const t="contextmenu"===e.type||e.shiftKey||"compat"===e.detail,n=[Object.assign({[p.STORAGE_KEY]:p.__values,order:await d.API.styles.getOrder()},await L.getLZValues()),...(await d.API.styles.getAll()).map(function(e){const n={};for(let[a,s]of Object.entries(e))("sections"===a?!e.usercssData||t||(s=[{code:""}]):"object"!=typeof s||!(0,l.isEmptyObj)(s))&&(n[a]=s);return n})],a=JSON.stringify(n,null,"  "),o="application/json";(0,s.$create)("a",{href:URL.createObjectURL(new Blob([a],{type:o})),download:function(){const e=new Date,t=("0"+e.getDate()).substr(-2),n=("0"+(e.getMonth()+1)).substr(-2);return`stylus-${e.getFullYear()}-${n}-${t}.json`}(),type:o}).dispatchEvent(new MouseEvent("click"))}let T,S,I;Object.assign((0,s.$)("#file-all-styles"),{onclick:exportToFile,oncontextmenu:exportToFile}).on("split-btn",exportToFile),(0,s.$)("#unfile-all-styles").onclick=()=>importFromFile(),Object.assign(document.body,{ondragover(e){const t=e.dataTransfer.types.includes("Files");e.dataTransfer.dropEffect=t||"search"===e.target.type?"copy":"none",this.classList.toggle("dropzone",t),t&&(e.preventDefault(),this.classList.remove("fadeout"))},ondragend(){(0,o.animateElement)(this,"fadeout","dropzone")},ondragleave(e){try{e.target===this&&this.ondragend()}catch{this.ondragend()}},ondrop(e){e.dataTransfer.files.length&&(e.preventDefault(),(0,s.$)("#only-updates input").checked&&(0,s.$)("#only-updates input").click(),importFromFile(e.dataTransfer.files[0])),setTimeout(()=>this.ondragend(),250)}});let O=performance.now(),A="";const D=(0,s.$create)("textarea",{id:"incremental-search",spellcheck:!1,tabIndex:-1,oninput:incrementalSearch});function incrementalSearch(e,t){const{key:n}=e;if(!t)return void(0,l.debounce)(incrementalSearch,100,{},!0);const a="ArrowUp"===n?-1:"ArrowDown"===n?1:0,i=D.value.toLocaleLowerCase();if(a&&e.preventDefault(),!i.trim()||!a&&(i===T||A.startsWith(i)))return void(T=i);let r,d=1e6;const c=[...(0,s.$)("#message-box")?(0,s.$$)(".injection-order-entry"):h.installed.children],p=c.indexOf(I);let u;p>0&&(a>0?r=c.slice(p+1).concat(c.slice(0,p+1)):a<0&&(r=c.slice(0,p).reverse().concat(c.slice(p).reverse())));for(const e of r||c){if(e.classList.contains("hidden"))continue;const t=e.styleNameLC.indexOf(i);if(0===t){u=e;break}if(t>0&&(t<d||a)&&(u=e,d=t,a))break}return u&&u!==I?(I=u,S=(0,s.$)("a",u),A=u.styleNameLC,(0,o.scrollElementIntoView)(u,{invalidMarginRatio:.25}),(0,o.animateElement)(u,"highlight-quick"),replaceInlineStyle({width:S.offsetWidth+"px",height:S.offsetHeight+"px",opacity:"1"}),S.prepend(D),D.focus(),!0):void 0}function replaceInlineStyle(e){for(const t in e)D.style.setProperty(t,e[t],"important")}function addEntryTitle(e){const t=e.closest(".entry").styleMeta,{installDate:n,updateDate:a,usercssData:s}=t;e.title=[a||n?`${(0,i.formatRelativeDate)(a||n)}`:"",`${(0,i.t)("dateInstalled")}: ${(0,i.formatDate)(n,!0)||"—"}`,`${(0,i.t)("dateUpdated")}: ${(0,i.formatDate)(a,!0)||"—"}`,s?`UserCSS, v.${s.version}`:""].filter(Boolean).join("\n")}function lazyAddEntryTitle({type:e,target:t}){const n=t.closest("h2.style-name, [data-type=age]");if(n){const t=(0,s.$)(".style-name-link",n)||n;"mouseover"!==e||t.title?l.debounce.unregister(addEntryTitle):(0,l.debounce)(addEntryTitle,50,t)}}replaceInlineStyle({opacity:"0"}),document.body.appendChild(D),e.on("keydown",function(e){if(e.altKey||e.metaKey)return;const t=(0,s.$)("#message-box");if(t&&!t.classList.contains("injection-order"))return;const n=(0,s.$isTextInput)(e.target),{key:a,code:o,ctrlKey:i}=e;if("KeyF"===o&&i&&!e.shiftKey||("Slash"===o||"/"===a)&&!i&&!n)return e.preventDefault(),void(t||(0,s.$)("#search").focus());if(i||n&&e.target!==D)return;const l=performance.now();1===a.length?(l-O>1e3&&(D.value="")," "!==a||D.value?(D.focus(),O=l):D.blur()):"Enter"===a&&S?S.dispatchEvent(new MouseEvent("click",{bubbles:!0})):("ArrowUp"===a||"ArrowDown"===a)&&!e.shiftKey&&l-O<5e3&&incrementalSearch(e,!0)?O=l:e.target===D&&((S||document.body).focus(),D.value="")},!0),h.installed.on("mouseover",lazyAddEntryTitle,{passive:!0}),h.installed.on("mouseout",lazyAddEntryTitle,{passive:!0}),(0,s.$)("#sync-styles").onclick=(0,s.$)("#manage-options-button").onclick=c.makeToggle("stylus-options",async function(t,n,a){document.title=(0,i.t)(t?"optionsHeading":"styleManager"),t?(s.$.root.appendChild((0,s.$create)("iframe"+a,{src:"/options.html"})).focus(),await new Promise(t=>e.closeOptions=t)):(await(0,o.animateElement)(n,"fadeout"),n.remove())}),(0,s.$)("#injection-order-button").onclick=c.makeToggle("injection-order",async function(e,t,n){if(!e)return o.messageBox.close();const l=".injection-order-entry",[r]=await Promise.all([d.API.styles.getAllOrdered(["_id","id","name","enabled"]),a.e("manage_injection-order_css").then(a.bind(a,2130))]),c={},p={},u=(0,s.$create)("li"+l,[p.name=(0,s.$create)("a",{target:"_blank",draggable:!1}),(0,s.$create)("a.injection-order-toggle",{tabIndex:0,draggable:!1,title:(0,i.t)("styleInjectionImportance")})]);function makeEntry(e){return u.classList.toggle("enabled",e.enabled),p.name.href="/edit.html?id="+e.id,p.name.textContent=e.name,Object.assign(u.cloneNode(!0),{styleNameLC:e.name.toLocaleLowerCase()})}await o.messageBox.show({title:(0,i.t)("styleInjectionOrder"),contents:(0,s.$create)("fragment",Object.entries(r).map(function([e,t]){const n=r[e]=t.map(e=>e._id),a=c[e]=(0,s.$create)("ol.scroller");let o;return a.append(...t.map(makeEntry)),a.on("d:dragstart",({detail:e})=>{e.origin.dataTransfer.setDragImage(new Image,0,0),o=a.scrollHeight+a.offsetTop-e.dragTarget.offsetHeight-e.dragTarget.offsetTop}),a.on("d:dragmove",({detail:e})=>{e.origin.stopPropagation(),e.origin.dataTransfer.dropEffect="move";const t=Math.min(e.currentPos.y-e.startPos.y,o);e.dragTarget.style.transform=`translateY(${t}px)`}),a.on("d:dragend",({detail:e})=>{const[t]=n.splice(e.originalIndex,1);n.splice(e.spliceIndex,0,t),a.insertBefore(e.dragTarget,e.insertBefore),d.API.styles.setOrder(r)}),a.on("click",t=>{if(t.target.closest(".injection-order-toggle")){const a=t.target.closest(l),s=[].indexOf.call(a.parentNode.children,a),[o]=n.splice(s,1),i="main"===e?"prio":"main";r[i].push(o),c[i].appendChild(a),d.API.styles.setOrder(r)}}),DraggableList(a,{scrollContainer:a}),(0,s.$create)("section",{["data-"+e]:""},[(0,s.$create)("header",(0,i.t)("styleInjectionOrderHint"+("main"===e?"":"_"+e))),a])})),className:"center-dialog "+n.slice(1),blockScroll:!0,buttons:[(0,i.t)("confirmClose")]})}),(0,s.$)("#update-history-button").onclick=c.makeToggle("update-history",async function(e,t,n){if(!e)return o.messageBox.close();const a=(0,s.$create)(n);let l,r,c=!1;const[p=[],m]=await Promise.all([u.chromeLocal.getValue("updateLog"),d.API.updater.getStates()]),g=p.join("\n");function scrollToBottom(){l.scrollTop=1e9}function calcScrollRatio(){return(l.scrollTop+l.clientHeight)/l.scrollHeight}function toggleSkipped(){if(c)return;const e=calcScrollRatio();a.textContent=this.checked?g.replace(this.rxRemoveNOP,""):g,Math.abs(e-calcScrollRatio())>.1&&(l.scrollTop=e*l.scrollHeight-l.clientHeight)}await o.messageBox.show({title:(0,i.t)("updateCheckHistory"),className:"center-dialog",contents:a,blockScroll:!0,buttons:[(0,i.t)("confirmOK"),g&&{textContent:(0,i.t)("confirmDelete"),onclick:function(){c?(u.chromeLocal.setValue("updateLog",g.split("\n")),setTimeout(scrollToBottom)):(u.chromeLocal.remove("updateLog"),a.textContent=""),c=!c,r.onchange(),this.textContent=(0,i.t)(c?"undo":"confirmDelete")}}],onshow:g&&(()=>{l=(0,s.$)("#message-box-contents"),l.tabIndex=0,setTimeout(()=>l.focus()),scrollToBottom(),(0,s.$)("#message-box-buttons button").insertAdjacentElement("afterend",(0,s.$create)("label",[r=(0,s.$create)("input",{type:"checkbox",checked:!0,onchange:toggleSkipped}),(0,i.t)("manageOnlyUpdates")])),r.rxRemoveNOP=new RegExp("^[^#]*("+Object.keys(m).filter(e=>e.startsWith("SAME_")).map(e=>m[e]).join("|")+").*\r?\n","gm"),r.onchange()})})}),c.update()}}])}