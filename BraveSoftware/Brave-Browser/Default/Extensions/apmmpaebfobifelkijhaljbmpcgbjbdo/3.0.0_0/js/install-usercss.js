{const e=this;(self.webpackChunkStylus=self.webpackChunkStylus||[]).push([["install-usercss"],{471:(t,n,s)=>{s(4404);var o=s(6759),a=s(8060),r=s(6001),l=s(9030),i=s(6308),c=s(9204),d=s(2691),u=s(7394),h=s(1679),p=s(9521),g=s(4523),m=s(4435);function DirectDownloader(e){const t={headers:{"Cache-Control":"no-cache, no-store"}};let n=null;return async()=>{const s=m.CHROME<99?await c.API.download(e,t):await(0,p.fetchText)(e,t);if(n!==s)return n=s,s}}const f="#message-box.config-dialog";let $,v,C,w,y,b,x,k,U,S=!0;function updateMeta(e,t=y){y=t;const n=e.usercssData,s=t&&t.usercssData,o=t&&(0,a.default)(n.version,s.version);$.setPreprocessor(n.preprocessor);const c=(0,i.t)(w?"installButtonInstalled":t?o>0?"installButtonUpdate":"installButtonReinstall":"installButton");if(document.title=`${c} ${n.name}`,(0,r.$)(".install").textContent=c,(0,r.$)(".install").classList.add(w?"installed":t?o>0?"update":"reinstall":"install"),t&&t.updateUrl&&((0,r.$)(".set-update-url").title=(0,i.t)("installUpdateFrom",t.updateUrl).replace(/\S+$/,"\n$&")),(0,r.$)(".meta-name").textContent=n.name,(0,r.$)(".meta-version").textContent=n.version,(0,r.$)(".meta-description").textContent=n.description,(0,r.$$)("#ss-scheme input").forEach(t=>{t.checked=t.value===(e.preferScheme||"none")}),replaceChildren((0,r.$)(".meta-author"),function(e){const t=e&&e.match(/^(.+?)(?:\s+<(.+?)>)?(?:\s+\((.+?)\))?$/);if(!t)return e;const[,n,s,o]=t,a=[];return s?a.push((0,r.$createLink)(`mailto:${s}`,n)):a.push((0,r.$create)("span",n)),o&&a.push((0,r.$createLink)(o,(0,r.$create)("i.i-external"))),a}(n.author),!0),replaceChildren((0,r.$)(".meta-license"),n.license,!0),replaceChildren((0,r.$)(".external-link"),function(){const e=[n.homepageURL&&[n.homepageURL,(0,i.t)("externalHomepage")],n.supportURL&&[n.supportURL,(0,i.t)("externalSupport")]];return(n.homepageURL||n.supportURL)&&(0,r.$create)("div",[(0,r.$create)("h3",(0,i.t)("externalLink")),(0,r.$create)("ul",e.map(e=>e&&(0,r.$create)("li",(0,r.$createLink)(...e))))])}()),getAppliesTo(e).then(e=>replaceChildren((0,r.$)(".applies-to"),e.map(e=>(0,r.$create)("li",e)))),Object.assign((0,r.$)(".configure-usercss"),{hidden:!n.vars,onclick:openConfigDialog}),n.vars){if(!(0,p.deepEqual)(n.vars,U)){U=n.vars;for(const[e,n]of Object.entries(t&&s.vars||{})){const t=U[e];t&&t.type===n.type&&(t.value=n.value)}}}else S=!1,(0,r.$$remove)(f);async function openConfigDialog(){(0,l.configDialog)(e)}shouldShowConfig()&&openConfigDialog(),(0,r.$)("#header").dataset.arrivedFast=performance.now()<500,(0,r.$)("#header").classList.add("meta-init"),(0,r.$)("#header").classList.remove("meta-init-error"),setTimeout(()=>(0,r.$$remove)(".lds-spinner"),1e3),showError(""),requestAnimationFrame(adjustCodeHeight),t&&enablePostActions()}function showError(e){if((0,r.$)(".warnings").textContent="",(0,r.$)(".warnings").classList.toggle("visible",Boolean(e)),document.body.classList.toggle("has-warnings",Boolean(e)),(e=Array.isArray(e)?e:[e])[0]){let t;((t=e[0].index)>=0||(t=e[0].offset)>=0)&&($.jumpToPos($.posFromIndex(t)),$.setSelections(e.map(e=>{const t=e.index>=0&&$.posFromIndex(e.index)||e.offset>=0&&{line:e.line-1,ch:e.col-1};return t&&{anchor:t,head:t}}).filter(Boolean)),$.focus()),(0,r.$)(".warnings").appendChild((0,r.$create)(".warning",[(0,i.t)("parseUsercssError"),"\n",...e.map(e=>e.message?(0,r.$create)("pre",e.message):e||"Unknown error")]))}adjustCodeHeight()}function showBuildError(e){(0,r.$)("#header").classList.add("meta-init-error"),console.error(e),showError(e)}function install(e){w=e,(0,r.$$remove)(".warning"),(0,r.$)("button.install").disabled=!0,(0,r.$)("button.install").classList.add("installed"),(0,r.$)("#live-reload-install-hint").hidden=!b.enabled,(0,r.$)(".set-update-url").title=e.updateUrl?(0,i.t)("installUpdateFrom",e.updateUrl):"",(0,r.$$)(".install-disable input").forEach(e=>e.disabled=!0),document.body.classList.add("installed"),enablePostActions(),updateMeta(e)}function enablePostActions(){const{id:e}=w||y;p.sessionStore.justEditedStyleId=e,(0,r.$)("#edit").search=`?id=${e}`,(0,r.$)("#delete").onclick=async()=>{await l.messageBox.confirm((0,i.t)("deleteStyleConfirm"),"danger center",(0,i.t)("confirmDelete"))&&(await c.API.styles.remove(e),k<0&&history.length>1?history.back():(0,g.closeCurrentTab)())}}async function getAppliesTo(e){if(x)try{e.sections=(await x).sections}catch(e){return showBuildError(e),[]}finally{x=null}let t=0;const n=[],s=["urls","urlPrefixes","domains","regexps"];for(const o of e.sections){const e=[].concat(...s.map(e=>o[e]).filter(Boolean));n.push(...e),t+=!e.length&&!(0,u.styleCodeEmpty)(o)}return n.sort(),n.length&&!t||n.push((0,i.t)("appliesToEverything")),[...new Set(n)]}function adjustCodeHeight(){const t=$.display.scroller,n=adjustCodeHeight.prevWindowHeight;(t.scrollHeight===t.clientHeight||n&&e.innerHeight!==n)&&(adjustCodeHeight.prevWindowHeight=e.innerHeight,$.setSize(null,(0,r.$)(".main").offsetHeight-(0,r.$)(".warnings").offsetHeight))}function initLiveReload(){let e=!1,t=0,n=Promise.resolve();return{get enabled(){return e},onToggled(n){n&&(e=n.target.checked),(w||y)&&(e?check({force:!0}):(clearTimeout(t),t=0),(0,r.$)(".install").disabled=e,Object.assign((0,r.$)("#live-reload-install-hint"),{hidden:!e,textContent:(0,i.t)("liveReloadInstallHint"+(k>=0?"FF":""))}))}};function check(e){v(e).then(update,logError).then(()=>{t=0,t=t||setTimeout(check,500)})}function logError(e){console.warn((0,i.t)("liveReloadError",e))}function update(e){null!=e&&(n=n.catch(console.error).then(()=>{const{id:t}=w||y,n=$.getScrollInfo(),s=$.getCursor();return $.setValue(e),$.setCursor(s),$.scrollTo(n.left,n.top),c.API.usercss.install({id:t,sourceCode:e}).then(updateMeta).catch(showError)}))}}function shouldShowConfig(){const e=S;return S=null!=(0,r.$)(f),e&&!S}function replaceChildren(e,t,n){e.firstChild&&(e.textContent=""),t&&e.append(...Array.isArray(t)?t:[t]),n&&(e.parentNode.hidden=!e.firstChild)}document.on("visibilitychange",()=>{(0,r.$$remove)("#message-box:not(.config-dialog)"),w&&b.onToggled()}),(0,i.tBody)(),setTimeout(()=>!$&&(0,l.showSpinner)((0,r.$)("#header")),200),async function(){location.hash&&history.replaceState(null,"",location.pathname+"?updateUrl="+encodeURIComponent(location.hash.slice(1)));const t=e.fsh,n=new URLSearchParams(location.search);let s;if(k=n.has("tabId")?Number(n.get("tabId")):-1,C=t?t._url:n.get("updateUrl"),t){let e=null;v=async()=>{const n=await(await t.getFile()).text();if(e!==n)return e=n},s=v()}else C?k<0&&(v=DirectDownloader(C),s=c.API.usercss.getInstallCode(C).then(e=>e||v()).catch(v)):history.length>1?history.back():(0,g.closeCurrentTab)();const u=browser.extension.isAllowedFileSchemeAccess();let m,f,w,y;(0,i.fetchTemplate)("/edit.html","styleSettings").then(e=>{e.firstChild.remove(),e.lastChild.remove(),(0,r.$)("#styleSettings").append(e)});try{y=await s,({dup:m,style:f}=await c.API.usercss.build({sourceCode:y,checkDup:!0,metaOnly:!0})),x=c.API.usercss.buildCode(f)}catch(e){w=e}b=initLiveReload();const[U]=await Promise.all([u,d.ready]);if(!f&&null==y)return void l.messageBox.alert(isNaN(w)?`${w}`:"HTTP Error "+w,"pre");const S=d.get(o.THEME_KEY);if((0,o.loadCmTheme)(S),$=(0,o.CodeMirror)((0,r.$)(".main"),{value:y||f.sourceCode,readOnly:!0,colorpicker:!0,theme:S}),e.on("resize",adjustCodeHeight),w&&showBuildError(w),!f)return;const L=f.usercssData,E=m&&m.usercssData,I=m&&(0,a.default)(L.version,E.version);updateMeta(f,m),m&&(((0,r.$)(`[name="ss-scheme"][value="${m.preferScheme}"]`)||{}).checked=!0);for(let e of["in","ex"]){const t=(0,r.$)("#ss-"+(e+="clusions")),n=m&&m[e]||[];t.value=n.join("\n")+(n[0]?"\n":""),t.rows=n.length+2,t.onchange=()=>{f[e]=t.value.split(/\n/).map(e=>e.trim()).filter(Boolean)}}I<0&&(0,r.$)("h1").after((0,r.$create)(".warning",(0,i.t)("versionInvalidOlder"))),(0,r.$)("button.install").onclick=()=>{shouldShowConfig(),(m?l.messageBox.confirm((0,r.$create)("span",(0,i.t)("styleInstallOverwrite",[L.name+(m.customName?` (${m.customName})`:""),E.version,L.version]))):Promise.resolve(!0)).then(e=>e&&c.API.usercss.install(f).then(install).catch(e=>l.messageBox.alert((0,i.t)("styleInstallFailed",e.message||e),"pre")))};const T=(0,r.$)(".set-update-url input[type=checkbox]"),A=(0,p.tryURL)(f.updateUrl||C||m&&m.updateUrl);A?m&&m.updateUrl===A.href?(T.checked=!0,T.disabled=!0):("file:"!==A.protocol||U)&&(T.checked=!0,f.updateUrl=A.href):T.disabled=!0,T.onchange=()=>{f.updateUrl=T.checked?A.href:null},T.onchange(),(0,r.$)(".set-update-url p").textContent=(0,p.clipString)(A.href||"",300),(0,r.$)("#ss-scheme").onchange=e=>{f.preferScheme=e.target.value},!C||(0,h.isLocalhost)(C)?(0,r.$)(".live-reload input").onchange=b.onToggled:(0,r.$)(".live-reload").remove()}()}},e=>{e.O(0,["common-ui","codemirror","css_global-dark_css-css_global_css-css_spinner_css"],()=>e(e.s=471)),e.O()}])}